
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>run_external &#8212; Sphinx documentation V0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for run_external</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">limr</span>
<span class="kn">from</span> <span class="nn">scipy.fftpack</span> <span class="kn">import</span> <span class="n">fft</span><span class="p">,</span> <span class="n">fftshift</span><span class="p">,</span> <span class="n">fftfreq</span><span class="p">,</span> <span class="n">ifft</span><span class="p">,</span> <span class="n">ifftshift</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">serial</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="c1">#from subprocess import call, Popen</span>
<span class="c1">#import itertools</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RUN sequenz&quot;</span><span class="p">)</span>

<span class="n">external_hardware</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># False True</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;OS&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Windows_NT&#39;</span><span class="p">:</span>
    <span class="n">external_hardware</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1">#save_dh5_file = &#39;./pulse/FID&#39;</span>
<span class="n">save_dh5_file</span> <span class="o">=</span> <span class="s1">&#39;./log/dh5_file&#39;</span>


<span class="c1"># helper fuktion</span>
<div class="viewcode-block" id="string2array"><a class="viewcode-back" href="../index.html#run_external.string2array">[docs]</a><span class="k">def</span> <span class="nf">string2array</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Format string to a array which is seperated by a &quot;,&quot;</span>

<span class="sd">    :param value: a long string to be split </span>
<span class="sd">    :type value: str</span>
<span class="sd">    :return: array of split of handed over sring </span>
<span class="sd">    :rtype: array</span>

<span class="sd">    :Example:</span>
<span class="sd">    &gt;&gt;&gt; [1.2 ,1.3 ,1.4 ,1.5 ,1.6 ,1.7  ] = string2array(&quot;[1.2,1.3,1.4,1.5,1.6,1.7]&quot;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
    <span class="c1"># print(&quot;def string2array&quot;, value)</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span></div>

<span class="c1"># sequenz selection</span>


<div class="viewcode-block" id="send_sdr"><a class="viewcode-back" href="../index.html#run_external.send_sdr">[docs]</a><span class="k">def</span> <span class="nf">send_sdr</span><span class="p">(</span><span class="n">value_main</span><span class="p">,</span> <span class="n">value_sequenz</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Execution of the sequence from the main window.</span>
<span class="sd">    It will hand over the parameters to the sequence what will send all parameterst to the sdr and will control the execution of the sequence.</span>
<span class="sd">    It handels the returened data from the sequence and will save it to set filestrukture</span>

<span class="sd">    :param value_main: all parameterst structured from the main window </span>
<span class="sd">    :type value_main: dict</span>
<span class="sd">    :param value_sequenz: all parameters structured dependent on the sequence</span>
<span class="sd">    :type value_sequenz: dict</span>

<span class="sd">    :Example:</span>

<span class="sd">    &gt;&gt;&gt; run_external.send_sdr(self.get_values(), self.value_sequenz)     </span>
<span class="sd">    value_main =</span>
<span class="sd">     {&#39;freq&#39;: {&#39;freq_start&#39;: &#39;80&#39;, &#39;freq_end&#39;: &#39;100&#39;, &#39;freq_step&#39;: &#39;100&#39;, &#39;freq_repetitions&#39;: &#39;10&#39;},</span>
<span class="sd">     &#39;tunematch&#39;: {&#39;tune&#39;: &#39;3.3&#39;, &#39;match&#39;: &#39;5&#39;, &#39;step&#39;: &#39;10&#39;, &#39;lut&#39;: &#39;10&#39;},</span>
<span class="sd">     &#39;load&#39;: {&#39;sample&#39;: &#39;_test_Sample&#39;, &#39;experiment&#39;: &#39;_test_Experiment&#39;, &#39;data&#39;: &#39;_test_Data&#39;}</span>
<span class="sd">     &#39;sequenz&#39;: {&#39;sequenz&#39;: &#39;fid&#39;}} # fid, spin, comp, spin_phase,own</span>
<span class="sd">    sequenz_select = {&#39;start&#39;: {&#39;datum created:&#39;: &#39;2022-01-19 23:26:53.497312&#39;, &#39;user created:&#39;: &#39;User: laborPC&#39;, &#39;experiment:&#39;: &quot;[&#39;Experiment initialise&#39;]&quot;, &#39;experiment parameter:&#39;: &#39;[1.2]&#39;},</span>
<span class="sd">     &#39;setting&#39;: {&#39;sequenz_type&#39;: &#39;fid&#39;, &#39;target_freq&#39;: &#39;83.62&#39;, &#39;band_freq&#39;: &#39;1.2&#39;, &#39;lo_freq&#39;: &#39;82420000.0&#39;},</span>
<span class="sd">     &#39;SDR setting&#39;: {&#39;correction_tx_i_dc&#39;: &#39;-45&#39;, &#39;correction_tx_q_dc&#39;: &#39;0&#39;, &#39;correction_tx_i_gain&#39;: &#39;2047&#39;, &#39;correction_tx_q_gain&#39;: &#39;2039&#39;, &#39;correction_tx_pahse&#39;: &#39;3&#39;,    &#39;correction_rx_i_dc&#39;: &#39;0&#39;, &#39;correction_rx_q_dc&#39;: &#39;0&#39;, &#39;correction_rx_i_gain&#39;: &#39;2047&#39;, &#39;correction_rx_q_gain&#39;: &#39;2047&#39;, &#39;correction_rx_phase&#39;: &#39;0&#39;, &#39;low_pass_rx&#39;: &#39;3000000.0&#39;, &#39;low_pass_tx&#39;: &#39;130000000.0&#39;, &#39;gain_rx&#39;: &#39;55.0&#39;, &#39;gain_tx&#39;: &#39;40.0&#39;},</span>
<span class="sd">     &#39;Puls&#39;: {&#39;puls_freq&#39;: &#39;[1.2]&#39;, &#39;puls_duration&#39;: &#39;[3e-06]&#39;, &#39;puls_amplitude&#39;: &#39;[1]&#39;, &#39;puls_arangement&#39;: &#39;[300]&#39;, &#39;puls_count&#39;: &#39;1&#39;},</span>
<span class="sd">     &#39;Phase&#39;: {&#39;phase_number&#39;: &#39;[4, 1]&#39;, &#39;phase_level&#39;: &#39;[0, 1]&#39;, &#39;phase_puls&#39;: &#39;[0, 0.7853981633974483]&#39;, &#39;number_phase_level&#39;: &#39;1&#39;},</span>
<span class="sd">     &#39;Readout&#39;: {&#39;repetition_time&#39;: &#39;5&#39;, &#39;acquisition_time&#39;: &#39;82&#39;, &#39;gate_signal&#39;: &#39;[1, 0, 50, 10]&#39;}}</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RUN SDR sequenz &quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;value_main &quot;</span><span class="p">,</span> <span class="n">value_main</span><span class="p">)</span>

    <span class="n">sequenz_select</span> <span class="o">=</span> <span class="n">value_main</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sequenz&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sequenz&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;value_sequenz &quot;</span><span class="p">,</span> <span class="n">value_sequenz</span><span class="p">)</span>

    <span class="n">sequenz_select</span> <span class="o">=</span> <span class="n">value_sequenz</span><span class="p">[</span><span class="s2">&quot;setting&quot;</span><span class="p">][</span><span class="s2">&quot;sequenz_type&quot;</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;selected sequenz: &quot;</span><span class="p">,</span> <span class="n">sequenz_select</span><span class="p">)</span>
    <span class="n">sequenz_freq_step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_main</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;freq&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;freq_step&quot;</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;frequenzy step, singel=1 or multi-band&gt;1:&quot;</span><span class="p">,</span> <span class="n">sequenz_freq_step</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sequenz_select</span> <span class="o">==</span> <span class="s2">&quot;fid&quot;</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">sequenz_freq_step</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># Frequency band</span>
            <span class="p">[</span><span class="n">x_time</span><span class="p">,</span> <span class="n">y_time</span><span class="p">,</span> <span class="n">x_freq</span><span class="p">,</span> <span class="n">y_freq</span><span class="p">]</span> <span class="o">=</span> <span class="n">broad_seq_fid</span><span class="p">(</span>
                <span class="n">value_main</span><span class="p">,</span> <span class="n">value_sequenz</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># one Frequency</span>
            <span class="p">[</span><span class="n">x_time</span><span class="p">,</span> <span class="n">y_time</span><span class="p">,</span> <span class="n">x_freq</span><span class="p">,</span> <span class="n">y_freq</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq_fid</span><span class="p">(</span>
                <span class="n">value_main</span><span class="p">,</span> <span class="n">value_sequenz</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">sequenz_select</span> <span class="o">==</span> <span class="s2">&quot;spin&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="n">x_time</span><span class="p">,</span> <span class="n">y_time</span><span class="p">,</span> <span class="n">x_freq</span><span class="p">,</span> <span class="n">y_freq</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq_spin</span><span class="p">(</span><span class="n">value_main</span><span class="p">,</span> <span class="n">value_sequenz</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">sequenz_select</span> <span class="o">==</span> <span class="s2">&quot;comp&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="n">x_time</span><span class="p">,</span> <span class="n">y_time</span><span class="p">,</span> <span class="n">x_freq</span><span class="p">,</span> <span class="n">y_freq</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq_comp</span><span class="p">(</span><span class="n">value_main</span><span class="p">,</span> <span class="n">value_sequenz</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">sequenz_select</span> <span class="o">==</span> <span class="s2">&quot;spin_phase&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="n">x_time</span><span class="p">,</span> <span class="n">y_time</span><span class="p">,</span> <span class="n">x_freq</span><span class="p">,</span> <span class="n">y_freq</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq_spin_phase</span><span class="p">(</span>
            <span class="n">value_main</span><span class="p">,</span> <span class="n">value_sequenz</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">sequenz_select</span> <span class="o">==</span> <span class="s2">&quot;own&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="n">x_time</span><span class="p">,</span> <span class="n">y_time</span><span class="p">,</span> <span class="n">x_freq</span><span class="p">,</span> <span class="n">y_freq</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq_own</span><span class="p">(</span><span class="n">value_main</span><span class="p">,</span> <span class="n">value_sequenz</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waring </span><span class="se">\n</span><span class="s2"> sequenz_select dose not exist!! </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sequenz_select</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  </span><span class="se">\n</span><span class="s2"> return values from sequenz&quot;</span><span class="p">)</span>
    <span class="c1"># store aquiried data to filestrukture</span>
    <span class="c1"># [22.52604167 22.55859375 22.59114583 22.62369792 22.65625 ]</span>
    <span class="c1"># x_time = [s.strip(&#39;\n&#39;) for s in x_time.tolist()]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; x_time </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">x_time</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>
    <span class="n">x_time</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x_time</span><span class="p">)</span>
    <span class="c1">#x_time = x_time.tolist()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; x_time </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">x_time</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">y_time</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">y_time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot; y_time </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">y_time</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>
    <span class="c1"># &lt;class &#39;numpy.complex128&#39;&gt; [(13.582009199130573-47.17961090224304j)]  y_time</span>

    <span class="c1"># [[0.29129709-1.5607999j] [0.53282316-0.78878987j] [0.88875632-1.65319897j] [1.04129911-1.4370967j ] [0.20866975-0.43285671j]]</span>
    <span class="n">y_time_abs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">y_time</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
    <span class="n">y_time_compex</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">y_time</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; y_time_abs</span><span class="se">\n</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">y_time_abs</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
    <span class="c1"># abs([0.88875632-1.65319897j]) !!!!</span>

    <span class="c1"># [83.02038574 83.07041931 83.12045288 83.17048645 83.22052002]</span>
    <span class="n">x_freq</span> <span class="o">=</span> <span class="n">x_freq</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; x_freq</span><span class="se">\n</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">x_freq</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>

    <span class="c1"># [[0.20988999] [0.06322438] [0.30136686] [0.06902654] [0.22243679]]</span>
    <span class="n">y_freq</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">y_freq</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; y_freq</span><span class="se">\n</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">y_freq</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;type x_time&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">x_time</span><span class="p">))</span>  <span class="c1"># type y_freq &lt;class &#39;list&#39;&gt;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;type y_time_abs&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">y_time_abs</span><span class="p">))</span>  <span class="c1"># type y_freq &lt;class &#39;list&#39;&gt;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;type x_freq&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">x_freq</span><span class="p">))</span>  <span class="c1"># type y_freq &lt;class &#39;list&#39;&gt;</span>
    <span class="c1"># type y_freq &lt;class &#39;list&#39;&gt;</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_freq</span><span class="p">),</span> <span class="s2">&quot;type y_freq&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">y_freq</span><span class="p">))</span>

    <span class="n">file_time</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;program&quot;</span><span class="p">,</span> <span class="s2">&quot;scan_data_time.csv&quot;</span><span class="p">)</span>
    <span class="n">file_freq</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;program&quot;</span><span class="p">,</span> <span class="s1">&#39;scan_data_freq.csv&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_time</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="p">)</span> <span class="k">as</span> <span class="n">seq_file</span><span class="p">:</span>
        <span class="n">wr</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">seq_file</span><span class="p">,</span> <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_ALL</span><span class="p">)</span>
        <span class="n">wr</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s2">&quot;x_time&quot;</span><span class="p">,</span> <span class="s2">&quot;y_time_abs&quot;</span><span class="p">,</span> <span class="s2">&quot;y_time_complex&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value_main</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_time</span><span class="p">):</span>
            <span class="n">wr</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x_time</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">y_time_abs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y_time_compex</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_freq</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="p">)</span> <span class="k">as</span> <span class="n">seq_file</span><span class="p">:</span>
        <span class="n">wr</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">seq_file</span><span class="p">,</span> <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_ALL</span><span class="p">)</span>
        <span class="n">wr</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s2">&quot;x_freq&quot;</span><span class="p">,</span> <span class="s2">&quot;y_freq&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value_main</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_freq</span><span class="p">):</span>
            <span class="n">wr</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x_freq</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">y_freq</span><span class="p">[</span><span class="n">i</span><span class="p">])])</span></div>


<div class="viewcode-block" id="seq_fid"><a class="viewcode-back" href="../index.html#run_external.seq_fid">[docs]</a><span class="k">def</span> <span class="nf">seq_fid</span><span class="p">(</span><span class="n">value_main</span><span class="p">,</span> <span class="n">value_sequenz</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;singel frequency Free Induction Decay (FID) sequence measurment</span>

<span class="sd">    :param value_main: all parameterst from the main window </span>
<span class="sd">    :type value_main: dict</span>
<span class="sd">    :param value_sequenz: all parameters dependent on the sequence</span>
<span class="sd">    :type value_sequenz: dict</span>
<span class="sd">    :raises Exception: Exception: if not possible to send to the hardware</span>
<span class="sd">    :return: steps time domain, amplitude time domain,steps frequency domain, amplitude frequency domain</span>
<span class="sd">    :rtype: [list, list, list, list]</span>


<span class="sd">    :Example:</span>
<span class="sd">    &gt;&gt;&gt; [x_time, y_time, x_freq, y_freq] = seq_fid(value_main, value_sequenz)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;fid seq </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">value_main</span><span class="p">)</span>

    <span class="c1"># l = limr.limr(&#39;./pulseN_test_USB.cpp&#39;)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">limr</span><span class="o">.</span><span class="n">limr</span><span class="p">(</span><span class="s1">&#39;./program/pulseN_test_USB.cpp&#39;</span><span class="p">)</span>

    <span class="c1"># hardcoded initialization of the lime. needed if parameters (e.g. Gain, tgi, tdi, are changed and need to be set to chip)</span>
    <span class="n">l</span><span class="o">.</span><span class="n">noi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1"># target frequency of the experiment</span>
    <span class="n">tgtfreq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_main</span><span class="p">[</span><span class="s2">&quot;freq&quot;</span><span class="p">][</span><span class="s2">&quot;freq_start&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">tgtfreq</span> <span class="o">=</span> <span class="mf">83.56e6</span>

    <span class="c1"># IF or base band frequency</span>
    <span class="n">if_frq</span> <span class="o">=</span> <span class="mf">1.2e6</span>

    <span class="c1"># LO frequency (target7 frequency - base band frequency)</span>
    <span class="n">l</span><span class="o">.</span><span class="n">lof</span> <span class="o">=</span> <span class="n">tgtfreq</span><span class="o">-</span><span class="n">if_frq</span>
    <span class="c1"># Sampling Rate</span>
    <span class="n">l</span><span class="o">.</span><span class="n">sra</span> <span class="o">=</span> <span class="mf">30.72e6</span>
    <span class="c1"># number of averages</span>
    <span class="n">l</span><span class="o">.</span><span class="n">nav</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s2">&quot;setting&quot;</span><span class="p">][</span><span class="s2">&quot;num_averages&quot;</span><span class="p">])</span>
    <span class="c1"># number of repetitions</span>

    <span class="n">l</span><span class="o">.</span><span class="n">nrp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;setting&#39;</span><span class="p">][</span><span class="s1">&#39;repetition_num&#39;</span><span class="p">])</span>
    <span class="c1"># TX I DC correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tdi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_tx_i_dc&#39;</span><span class="p">])</span>
    <span class="c1"># TX Q DC correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tdq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_tx_q_dc&#39;</span><span class="p">])</span>
    <span class="c1"># TX I Gain correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tgi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_tx_i_gain&#39;</span><span class="p">])</span>
    <span class="c1"># TX Q Gain correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tgq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_tx_q_gain&#39;</span><span class="p">])</span>
    <span class="c1"># TX phase adjustment</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tpc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_tx_pahse&#39;</span><span class="p">])</span>
    <span class="c1"># RX I Gain correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rgi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_rx_i_dc&#39;</span><span class="p">])</span>
    <span class="c1"># RX Q Gain correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rgq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_rx_q_dc&#39;</span><span class="p">])</span>
    <span class="c1"># RX I DC correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rdi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_rx_i_gain&#39;</span><span class="p">])</span>
    <span class="c1"># RX Q DC correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rdq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_rx_q_gain&#39;</span><span class="p">])</span>
    <span class="c1"># RX phase adjustment</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rpc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_rx_phase&#39;</span><span class="p">])</span>

    <span class="c1"># repetition and acquisition time (acquisition time can only be an integer multiple of the buffer size from Cpp, so the number here will automatically</span>
    <span class="c1"># be adjusted in the ways that it fits to an integer multiply of the buffer size</span>

    <span class="c1"># repetition time = 5e-3</span>
    <span class="n">l</span><span class="o">.</span><span class="n">trp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Readout&#39;</span><span class="p">][</span><span class="s1">&#39;repetition_time&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1"># acquisition time (gives minimum buffer size) =82e-6</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tac</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Readout&#39;</span><span class="p">][</span><span class="s1">&#39;acquisition_time&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span>

    <span class="c1"># GPIO Pin3 is centered around the pulse (used as a Gate Signal)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Readout&#39;</span><span class="p">][</span><span class="s1">&#39;gate_signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="n">l</span><span class="o">.</span><span class="n">t3d</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>   <span class="c1"># [1, 0, 50, 10]</span>

    <span class="c1"># pulse durations</span>
    <span class="c1"># pulse frequency</span>
    <span class="c1"># l.pfr = [if_frq]</span>
    <span class="n">l</span><span class="o">.</span><span class="n">pfr</span> <span class="o">=</span> <span class="p">[</span><span class="n">if_frq</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Puls&#39;</span><span class="p">][</span><span class="s1">&#39;number_pulses&#39;</span><span class="p">]))]</span>
    <span class="c1"># pulse  duration</span>
    <span class="n">l</span><span class="o">.</span><span class="n">pdr</span> <span class="o">=</span> <span class="n">string2array</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Puls&#39;</span><span class="p">][</span><span class="s1">&#39;puls_duration&#39;</span><span class="p">])</span>  <span class="c1"># [3e-6]</span>

    <span class="c1"># relative pulse amplitude (only makes sense if 2 or more pulses are in the sequence)</span>
    <span class="n">l</span><span class="o">.</span><span class="n">pam</span> <span class="o">=</span> <span class="p">[</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Puls&#39;</span><span class="p">][</span><span class="s1">&#39;puls_amplitude&#39;</span><span class="p">]</span>
             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Puls&#39;</span><span class="p">][</span><span class="s1">&#39;number_pulses&#39;</span><span class="p">]))]</span>  <span class="c1"># [1]</span>
    <span class="c1"># pulse arrangement 1 means immediate start of the pulse (3us from zero approx. is then start of the first pulse)</span>
    <span class="n">l</span><span class="o">.</span><span class="n">pof</span> <span class="o">=</span> <span class="n">string2array</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Puls&#39;</span><span class="p">][</span><span class="s1">&#39;puls_arangement&#39;</span><span class="p">])</span>  <span class="c1"># [300]</span>

    <span class="n">l</span><span class="o">.</span><span class="n">npu</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">pfr</span><span class="p">)</span>                                  <span class="c1"># number of pulses</span>

    <span class="n">l</span><span class="o">.</span><span class="n">rgn</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;gain_rx&#39;</span><span class="p">])</span>  <span class="c1"># 55.0    # RX gain</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tgn</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;gain_tx&#39;</span><span class="p">])</span>  <span class="c1"># 40.0  # TX gain</span>

    <span class="n">RX_gainfactor</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">rgn</span> <span class="o">==</span> <span class="mi">40</span><span class="p">:</span>
        <span class="n">RX_gainfactor</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">RX_gainfactor</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">((</span><span class="n">l</span><span class="o">.</span><span class="n">rgn</span><span class="o">-</span><span class="mi">40</span><span class="p">)</span><span class="o">/</span><span class="mi">20</span><span class="p">)</span>

    <span class="c1"># RX BW (IF or base band low pass filter)</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rlp</span> <span class="o">=</span> <span class="mf">3.0e6</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tlp</span> <span class="o">=</span> <span class="mf">130.0e6</span>                                     <span class="c1"># RX BW</span>

    <span class="n">l</span><span class="o">.</span><span class="n">spt</span> <span class="o">=</span> <span class="n">save_dh5_file</span>                            <span class="c1"># directory to save to</span>
    <span class="n">l</span><span class="o">.</span><span class="n">fpa</span> <span class="o">=</span> <span class="s1">&#39;setup&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> ________</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;start sequenz&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> ________</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">l</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="c1"># read back file and plot time signal + shifted fft</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">external_hardware</span><span class="p">):</span>

        <span class="c1"># reads back the file which was recently saved</span>
        <span class="n">l</span><span class="o">.</span><span class="n">readHDF</span><span class="p">()</span>

        <span class="c1"># evaluation range, defines: blanking time and window length</span>
        <span class="n">evran</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;setting&#39;</span><span class="p">][</span><span class="s1">&#39;blank_time&#39;</span><span class="p">]),</span>
                 <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;setting&#39;</span><span class="p">][</span><span class="s1">&#39;window_time&#39;</span><span class="p">])]</span>  <span class="c1"># [22.5, 42.5]</span>

        <span class="c1"># np.where sometimes does not work out, so it is put in a try except</span>
        <span class="c1"># always check the console for errors</span>

        <span class="n">evidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">l</span><span class="o">.</span><span class="n">HDF</span><span class="o">.</span><span class="n">tdx</span> <span class="o">&gt;</span> <span class="n">evran</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">HDF</span><span class="o">.</span><span class="n">tdx</span> <span class="o">&lt;</span> <span class="n">evran</span><span class="p">[</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># time domain x and y data</span>
        <span class="n">tdx</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">HDF</span><span class="o">.</span><span class="n">tdx</span><span class="p">[</span><span class="n">evidx</span><span class="p">]</span>
        <span class="n">tdy</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">HDF</span><span class="o">.</span><span class="n">tdy</span><span class="p">[</span><span class="n">evidx</span><span class="p">]</span>

        <span class="c1"># correcting a offset in the time domain by subtracting the mean</span>
        <span class="n">tdy_mean</span> <span class="o">=</span> <span class="n">tdy</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tdy</span><span class="p">)</span>

        <span class="c1"># fft of the corrected time domain data</span>
        <span class="n">fdy1</span> <span class="o">=</span> <span class="n">fftshift</span><span class="p">(</span><span class="n">fft</span><span class="p">(</span><span class="n">tdy_mean</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># fft freq and fft shift is here used to scale the x axis (frequency axis)</span>
        <span class="n">fdx1</span> <span class="o">=</span> <span class="n">fftfreq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fdy1</span><span class="p">))</span><span class="o">*</span><span class="mf">30.72</span>
        <span class="n">fdx1</span> <span class="o">=</span> <span class="n">fftshift</span><span class="p">(</span><span class="n">fdx1</span><span class="p">)</span>

        <span class="c1"># scaling factor which converts the y axis (usually a proportional number of points) into uV</span>
        <span class="n">fac_p_to_uV</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;factor_point2volts&#39;</span><span class="p">])</span>  <span class="c1"># 447651/1e6</span>
        <span class="c1"># fac_p_to_uV = 447651/1e6</span>
        <span class="n">tdy_mean</span> <span class="o">=</span> <span class="n">tdy_mean</span><span class="o">/</span><span class="n">l</span><span class="o">.</span><span class="n">nav</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tdx</span><span class="p">,</span> <span class="n">tdy_mean</span><span class="p">)</span>  <span class="c1"># zeit plot</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;t in µs&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Amplitude in µV&quot;</span><span class="p">)</span>
        <span class="c1"># plt.show()</span>

        <span class="c1"># get LO frequency and add it to the base band fft x-Axis in order to illustrate the applied frequency</span>
        <span class="c1"># for single side spectrum and shift (only single frequency)</span>
        <span class="n">lof</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">HDF</span><span class="o">.</span><span class="n">attr_by_key</span><span class="p">(</span><span class="s1">&#39;lof&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fdx1</span><span class="p">)):</span>
            <span class="n">fdx1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdx1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">lof</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span>

        <span class="c1"># cutting out the window of the interessting part of the computed fft spectrum (here from 83 - 84 MHz)</span>
        <span class="c1"># window of interest</span>
        <span class="n">shifter</span> <span class="o">=</span> <span class="mi">12</span>  <span class="c1"># 0#50</span>
        <span class="n">stopper</span> <span class="o">=</span> <span class="mi">270</span>  <span class="c1"># 300</span>
        <span class="c1"># here the right side of the spectrum is selected</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">fdy1</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fdy1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">shifter</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">fdy1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">stopper</span><span class="p">]))</span> <span class="o">/</span> \
            <span class="nb">len</span><span class="p">(</span><span class="n">tdx</span><span class="p">)</span><span class="o">/</span><span class="n">l</span><span class="o">.</span><span class="n">nav</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">fdx1</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fdy1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">shifter</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">fdy1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">stopper</span><span class="p">]</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>  <span class="c1"># freq plot</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;f in MHz&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Amplitude in µV&quot;</span><span class="p">)</span>
        <span class="c1"># plt.show()</span>

        <span class="c1"># print std (for SNR determination -&gt; noise analysis without sample)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;std rms frequency domain next to peak X: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>
        <span class="c1"># print max of fft (for SNR evaluation - should give peak maximum)</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s2">&quot;value y&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MAX of Signal: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">tdx</span><span class="p">,</span> <span class="n">tdy_mean</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>  <span class="c1"># time x-y , freq x-y</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot; hardware is missing&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="broad_seq_fid"><a class="viewcode-back" href="../index.html#run_external.broad_seq_fid">[docs]</a><span class="k">def</span> <span class="nf">broad_seq_fid</span><span class="p">(</span><span class="n">value_main</span><span class="p">,</span> <span class="n">value_sequenz</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;multi frequency Free Induction Decay (FID) sequence measurment</span>

<span class="sd">    :param value_main: all parameterst from the main window </span>
<span class="sd">    :type value_main: dict</span>
<span class="sd">    :param value_sequenz: all parameters dependent on the sequence</span>
<span class="sd">    :type value_sequenz: dict</span>
<span class="sd">    :raises Exception: Exception: if not possible to send to the hardware</span>
<span class="sd">    :return: steps time domain, amplitude time domain,steps frequency domain, amplitude frequency domain</span>
<span class="sd">    :rtype: [list, list, list, list]</span>


<span class="sd">    :Example:</span>
<span class="sd">    &gt;&gt;&gt; [x_time, y_time, x_freq, y_freq] = broad_seq_fid(value_main, value_sequenz)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;broad frequency FID&quot;</span><span class="p">)</span>

    <span class="n">U_Tune_max</span> <span class="o">=</span> <span class="mf">5.0</span>  <span class="c1"># max voltage for tuning cap</span>
    <span class="c1">#U_Tune_max = value_main.get(&quot;tunematch&quot;).get(&quot;tune&quot;)</span>
    <span class="n">U_Match_max</span> <span class="o">=</span> <span class="mf">5.0</span>  <span class="c1"># max voltage for matching cap</span>
    <span class="c1">#U_Match_max = value_main.get(&quot;tunematch&quot;).get(&quot;match&quot;)</span>

    <span class="c1">#vec = list()</span>
    <span class="c1">#ref = list()</span>
    <span class="n">ut</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">um</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="c1">#ref_list = list()</span>
    <span class="n">freqList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="n">start_flag</span> <span class="o">=</span> <span class="s1">&#39;Set_Voltage</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">arduino</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="s1">&#39;/dev/ttyACM0&#39;</span><span class="p">,</span> <span class="n">baudrate</span><span class="o">=</span><span class="mi">115200</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">arduino</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">start_flag</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;./program/scantry2.csv&#39;</span>
    <span class="n">TMfile</span> <span class="o">=</span> <span class="s1">&#39;./program/TM83_84.csv&#39;</span>
    <span class="n">averages</span> <span class="o">=</span> <span class="mi">5000</span>
    <span class="n">sampleRate</span> <span class="o">=</span> <span class="mf">30.72e6</span>

    <span class="c1"># open Tune-Match file and load the voltages and frequencies into seperate arrays</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">TMfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">float</span><span class="p">(</span><span class="n">col1</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">col2</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">col3</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">,</span> <span class="n">col3</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">]</span>

    <span class="n">np_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">np_data</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">freq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">np_data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">freqList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np_data</span><span class="p">[</span><span class="n">freq</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">freqList</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">freqList</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">utval</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">np_data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np_data</span><span class="p">[</span><span class="n">utval</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ut</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">umval</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">np_data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">um</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np_data</span><span class="p">[</span><span class="n">umval</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">um</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">um</span><span class="p">)</span>

    <span class="c1"># calculate the frequency step by the difference of two frequencies in the Tune-Match file</span>
    <span class="n">freq_step</span> <span class="o">=</span> <span class="p">(</span><span class="n">freqList</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">freqList</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">l</span> <span class="o">=</span> <span class="n">limr</span><span class="o">.</span><span class="n">limr</span><span class="p">(</span><span class="s1">&#39;./program/pulseN_test_USB.cpp&#39;</span><span class="p">)</span>  <span class="c1"># (&#39;./pulseN_test_USB.cpp&#39;)</span>
    <span class="n">l</span><span class="o">.</span><span class="n">sra</span> <span class="o">=</span> <span class="mf">30.72e6</span>                                      <span class="c1"># Sampling Rate</span>
    <span class="n">l</span><span class="o">.</span><span class="n">nav</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s2">&quot;setting&quot;</span><span class="p">][</span><span class="s2">&quot;num_averages&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">seq</span><span class="p">(</span><span class="n">tgtfreq</span><span class="p">):</span>
        <span class="c1"># IF or base band frequency</span>
        <span class="n">if_frq</span> <span class="o">=</span> <span class="mf">1.2e6</span>

        <span class="n">l</span><span class="o">.</span><span class="n">lof</span> <span class="o">=</span> <span class="n">tgtfreq</span><span class="o">-</span><span class="n">if_frq</span>                                  <span class="c1"># LO frequency</span>
        <span class="c1"># l.sra = 30.72e6                                      # Sampling Rate</span>

        <span class="c1"># number of averages</span>
        <span class="c1">#l.nav = float(value_sequenz[&quot;setting&quot;][&quot;num_averages&quot;])</span>
        <span class="n">l</span><span class="o">.</span><span class="n">nrp</span> <span class="o">=</span> <span class="mi">1</span>                                               <span class="c1"># number of repetitions</span>

        <span class="c1"># repetition and acquisition time (acquisition time can only be an integer multiple of the buffer size)</span>
        <span class="n">l</span><span class="o">.</span><span class="n">trp</span> <span class="o">=</span> <span class="mf">5e-3</span>                                            <span class="c1"># repetition time</span>
        <span class="n">l</span><span class="o">.</span><span class="n">tac</span> <span class="o">=</span> <span class="mf">82e-6</span>                                           <span class="c1"># acquisition time</span>
        <span class="c1"># GPIO Pin3 is centered around the pulse</span>
        <span class="n">l</span><span class="o">.</span><span class="n">t3d</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>

        <span class="n">l</span><span class="o">.</span><span class="n">tdi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">32</span>                                             <span class="c1"># TX I DC correction</span>
        <span class="n">l</span><span class="o">.</span><span class="n">tdq</span> <span class="o">=</span> <span class="mi">50</span>                                              <span class="c1"># TX Q DC correction</span>
        <span class="n">l</span><span class="o">.</span><span class="n">tgi</span> <span class="o">=</span> <span class="mi">2047</span>                                            <span class="c1"># TX I Gain correction</span>
        <span class="n">l</span><span class="o">.</span><span class="n">tgq</span> <span class="o">=</span> <span class="mi">2041</span>                                            <span class="c1"># TX Q Gain correction</span>
        <span class="n">l</span><span class="o">.</span><span class="n">tpc</span> <span class="o">=</span> <span class="mi">1</span>                                               <span class="c1"># TX phase adjustment</span>

        <span class="n">l</span><span class="o">.</span><span class="n">pfr</span> <span class="o">=</span> <span class="p">[</span><span class="n">if_frq</span><span class="p">]</span>
        <span class="n">l</span><span class="o">.</span><span class="n">pdr</span> <span class="o">=</span> <span class="p">[</span><span class="mf">16e-6</span><span class="p">]</span>
        <span class="n">l</span><span class="o">.</span><span class="n">pam</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">l</span><span class="o">.</span><span class="n">pof</span> <span class="o">=</span> <span class="p">[</span><span class="mi">300</span><span class="p">]</span>

        <span class="c1"># number of pulses</span>
        <span class="n">l</span><span class="o">.</span><span class="n">npu</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">pfr</span><span class="p">)</span>

        <span class="n">l</span><span class="o">.</span><span class="n">rgn</span> <span class="o">=</span> <span class="mf">55.0</span>                                            <span class="c1"># RX gain</span>
        <span class="n">l</span><span class="o">.</span><span class="n">tgn</span> <span class="o">=</span> <span class="mf">50.0</span>                                            <span class="c1"># TX gain</span>

        <span class="n">l</span><span class="o">.</span><span class="n">rlp</span> <span class="o">=</span> <span class="mf">3.0e6</span>                                           <span class="c1"># RX BW</span>
        <span class="n">l</span><span class="o">.</span><span class="n">tlp</span> <span class="o">=</span> <span class="mf">130.0e6</span>                                         <span class="c1"># RX BW</span>

        <span class="n">l</span><span class="o">.</span><span class="n">spt</span> <span class="o">=</span> <span class="s1">&#39;./pulse/FID&#39;</span>                                  <span class="c1"># directory to save to</span>
        <span class="n">l</span><span class="o">.</span><span class="n">fpa</span> <span class="o">=</span> <span class="s1">&#39;setup&#39;</span>

        <span class="n">l</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="c1"># read back file and plot time signal + shifted fft</span>
        <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">external_hardware</span><span class="p">):</span>

            <span class="c1"># reads back the file which was recently saved</span>
            <span class="n">l</span><span class="o">.</span><span class="n">readHDF</span><span class="p">()</span>

            <span class="c1"># evaluation range, defines: blanking time and window length</span>
            <span class="n">evran</span> <span class="o">=</span> <span class="p">[</span><span class="mf">36.5</span><span class="p">,</span> <span class="mf">56.5</span><span class="p">]</span>

            <span class="c1"># np.where sometimes does not work out, so it is put in a try except</span>
            <span class="c1"># always check the console for errors</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">evidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">l</span><span class="o">.</span><span class="n">HDF</span><span class="o">.</span><span class="n">tdx</span> <span class="o">&gt;</span> <span class="n">evran</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span>
                    <span class="n">l</span><span class="o">.</span><span class="n">HDF</span><span class="o">.</span><span class="n">tdx</span> <span class="o">&lt;</span> <span class="n">evran</span><span class="p">[</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;error due to np.where evaluation!&quot;</span><span class="p">)</span>

            <span class="c1"># time domain x and y data</span>
            <span class="n">tdx</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">HDF</span><span class="o">.</span><span class="n">tdx</span><span class="p">[</span><span class="n">evidx</span><span class="p">]</span>
            <span class="n">tdy</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">HDF</span><span class="o">.</span><span class="n">tdy</span><span class="p">[</span><span class="n">evidx</span><span class="p">]</span>

            <span class="c1"># correcting a offset in the time domain by subtracting the mean</span>
            <span class="n">tdy_mean</span> <span class="o">=</span> <span class="n">tdy</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tdy</span><span class="p">)</span>

            <span class="c1"># fft of the corrected time domain data</span>
            <span class="n">fdy1</span> <span class="o">=</span> <span class="n">fftshift</span><span class="p">(</span><span class="n">fft</span><span class="p">(</span><span class="n">tdy_mean</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># fft freq and fft shift is here used to scale the x axis (frequency axis)</span>
            <span class="n">fdx1</span> <span class="o">=</span> <span class="n">fftfreq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fdy1</span><span class="p">))</span><span class="o">*</span><span class="n">l</span><span class="o">.</span><span class="n">sra</span><span class="o">/</span><span class="mf">1e6</span>
            <span class="n">fdx1</span> <span class="o">=</span> <span class="n">fftshift</span><span class="p">(</span><span class="n">fdx1</span><span class="p">)</span>

            <span class="c1"># get LO frequency and add it to the base band fft x-Axis in order to illustrate the applied frequency</span>
            <span class="c1"># for single side spectrum and shift (only single frequency)</span>
            <span class="n">lof</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">HDF</span><span class="o">.</span><span class="n">attr_by_key</span><span class="p">(</span><span class="s1">&#39;lof&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fdx1</span><span class="p">)):</span>
                <span class="n">fdx1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdx1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">lof</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span>

            <span class="c1"># shifter takes the whole fft and shifts it away from zero point (zer0 if offset = 0 or low)</span>
            <span class="c1"># window of interest</span>
            <span class="n">shifter</span> <span class="o">=</span> <span class="mi">50</span>
            <span class="n">stopper</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># here the right side of the spectrum is selected</span>
            <span class="n">y</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">fdy1</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fdy1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">shifter</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">fdy1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">stopper</span><span class="p">]))</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">fdx1</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fdy1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">shifter</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">fdy1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">stopper</span><span class="p">]</span>

            <span class="c1"># calculate the idices which are in the excitation range to cut it out of the recorded spectrum</span>
            <span class="n">excitation_indeces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">tgtfreq</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="p">((</span><span class="n">tgtfreq</span><span class="o">+</span><span class="n">freq_step</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)))</span>

            <span class="c1"># print number of the cut out points</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;points per scan: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">excitation_indeces</span><span class="p">)))</span>

            <span class="n">x_exc</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">excitation_indeces</span><span class="p">]</span>

            <span class="n">y_exc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">excitation_indeces</span><span class="p">])</span>

            <span class="c1"># look if the filename exists or if new file needs to be produced</span>
            <span class="c1"># if not, create file and write the header into it</span>
            <span class="k">if</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Filename not given yet - new file will be generated!&quot;</span><span class="p">)</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;frequency</span><span class="se">\t</span><span class="s1">amplitude</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># if existing file, append recorded data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File does already exist, scan data will be appended!&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_exc</span><span class="p">)):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x_exc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">y_exc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">um</span><span class="p">)):</span>
        <span class="c1"># set voltages for certain frequency</span>
        <span class="n">start_flag</span> <span class="o">=</span> <span class="s1">&#39;Set_Voltage</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">arduino</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">start_flag</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
        <span class="n">UT</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ut</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mi">4095</span><span class="o">/</span><span class="n">U_Tune_max</span><span class="p">)</span>
        <span class="n">UM</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">um</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mi">4095</span><span class="o">/</span><span class="n">U_Match_max</span><span class="p">)</span>

        <span class="n">UT</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">UT</span><span class="p">)</span>
        <span class="n">UM</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">UM</span><span class="p">)</span>

        <span class="c1"># send the voltages to the Arduino</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">arduino</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ready</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="n">arduino</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">UT</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">arduino</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;stop</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">arduino</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">UM</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">arduino</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;stop</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">arduino</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;done</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Successfully sent: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tune-voltage: &#39;</span> <span class="o">+</span> <span class="n">arduino</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Match-voltage: &#39;</span> <span class="o">+</span> <span class="n">arduino</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error by sending data to Arduino&#39;</span><span class="p">)</span>

        <span class="c1"># print the current frequency which will be applied</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current Excitation Frequency: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">freqList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; MHz&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># call the FIDcut. sequence to carry out the experiment at the frequency step</span>
        <span class="n">seq</span><span class="p">(</span><span class="n">freqList</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="c1"># close arduino connection</span>
    <span class="n">arduino</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># plot the resulting spectrum of the whole scan</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">float</span><span class="p">(</span><span class="n">col1</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">col2</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">,</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">]</span>

    <span class="n">np_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">np_data</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">np_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;f in MHz&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Amplitude&quot;</span><span class="p">)</span>
    <span class="c1"># plt.show()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;STD: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])))</span>

    <span class="n">x_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">22.0</span><span class="p">,</span> <span class="mf">22.1</span><span class="p">,</span> <span class="mf">22.2</span><span class="p">,</span> <span class="mf">22.3</span><span class="p">,</span> <span class="mf">22.4</span><span class="p">,</span>
                      <span class="mf">22.5</span><span class="p">,</span> <span class="mf">22.6</span><span class="p">,</span> <span class="mf">22.7</span><span class="p">,</span> <span class="mf">22.8</span><span class="p">,</span> <span class="mf">22.9</span><span class="p">])</span>
    <span class="n">y_time</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.2</span><span class="o">+</span><span class="mf">9.70</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span><span class="o">+</span><span class="mf">3.0</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span> <span class="o">+</span> <span class="mf">5.31</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="o">+</span><span class="mf">3.0</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span> <span class="o">-</span>
              <span class="mf">0.4</span><span class="n">j</span><span class="p">,</span> <span class="mf">0.4</span><span class="o">-</span><span class="mf">2.3</span><span class="n">j</span><span class="p">,</span> <span class="mf">1.3</span><span class="o">-</span><span class="mf">3.3</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">-</span><span class="mf">4.1</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.7</span><span class="o">-</span><span class="mf">6.4</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.9</span><span class="o">-</span><span class="mf">7.0</span><span class="n">j</span><span class="p">]</span>
    <span class="n">y_time</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.3</span><span class="o">+</span><span class="n">i</span> <span class="o">+</span> <span class="mf">1.50</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
    <span class="n">y_time</span> <span class="o">=</span> <span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">y_time</span><span class="p">]</span>

    <span class="n">x_freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">y_freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]])</span>

    <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">external_hardware</span><span class="p">):</span>
        <span class="c1">#print(&quot;np_data[:, 0]&quot;, np_data[:, 0])</span>
        <span class="c1">#print(&quot;np_data[:, 1]&quot;, np_data[:, 1])</span>
        <span class="k">return</span> <span class="n">x_time</span><span class="p">,</span> <span class="n">y_time</span><span class="p">,</span> <span class="n">x_freq</span><span class="p">,</span> <span class="n">y_freq</span>  <span class="c1"># time x-y , freq x-y</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot; hardware is missing&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="seq_spin"><a class="viewcode-back" href="../index.html#run_external.seq_spin">[docs]</a><span class="k">def</span> <span class="nf">seq_spin</span><span class="p">(</span><span class="n">value_main</span><span class="p">,</span> <span class="n">value_sequenz</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Spin-Echo sequence </span>

<span class="sd">    :param value_main: all parameterst from the main window </span>
<span class="sd">    :type value_main: dict</span>
<span class="sd">    :param value_sequenz: all parameters dependent on the sequence</span>
<span class="sd">    :type value_sequenz: dict</span>
<span class="sd">    :raises Exception: Exception: if not possible to send to the hardware</span>
<span class="sd">    :return: steps time domain, amplitude time domain,steps frequency domain, amplitude frequency domain</span>
<span class="sd">    :rtype: [list, list, list, list]</span>


<span class="sd">    :Example:</span>
<span class="sd">    &gt;&gt;&gt; [x_time, y_time, x_freq, y_freq] = seq_spin(value_main, value_sequenz)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># l = limr.limr(&#39;./pulseN_test_USB.cpp&#39;)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">limr</span><span class="o">.</span><span class="n">limr</span><span class="p">(</span><span class="s1">&#39;./program/pulseN_test_USB.cpp&#39;</span><span class="p">)</span>

    <span class="c1"># hardcoded initialization of the lime. needed if parameters (e.g. Gain, tgi, tdi, are changed and need to be set to chip)</span>
    <span class="n">l</span><span class="o">.</span><span class="n">noi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1"># target frequency of the experiment</span>
    <span class="n">tgtfreq</span> <span class="o">=</span> <span class="mf">83.62e6</span>  <span class="c1"># 119.3e6#90.4e6</span>

    <span class="c1"># IF or base band frequency</span>
    <span class="n">if_frq</span> <span class="o">=</span> <span class="mf">1.2e6</span>

    <span class="c1"># LO frequency (target frequency - base band frequency)</span>
    <span class="n">l</span><span class="o">.</span><span class="n">lof</span> <span class="o">=</span> <span class="n">tgtfreq</span><span class="o">-</span><span class="n">if_frq</span>
    <span class="n">sample_rate_sdr</span> <span class="o">=</span> <span class="mf">30.72e6</span>
    <span class="n">l</span><span class="o">.</span><span class="n">sra</span> <span class="o">=</span> <span class="n">sample_rate_sdr</span>                                   <span class="c1"># Sampling Rate</span>
    <span class="n">l</span><span class="o">.</span><span class="n">nav</span> <span class="o">=</span> <span class="mi">1000</span>                                        <span class="c1"># number of averages</span>

    <span class="n">l</span><span class="o">.</span><span class="n">nrp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;setting&#39;</span><span class="p">][</span><span class="s1">&#39;repetition_num&#39;</span><span class="p">])</span>
    <span class="c1"># TX I DC correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tdi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_tx_i_dc&#39;</span><span class="p">])</span>
    <span class="c1"># TX Q DC correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tdq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_tx_q_dc&#39;</span><span class="p">])</span>
    <span class="c1"># TX I Gain correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tgi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_tx_i_gain&#39;</span><span class="p">])</span>
    <span class="c1"># TX Q Gain correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tgq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_tx_q_gain&#39;</span><span class="p">])</span>
    <span class="c1"># TX phase adjustment</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tpc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_tx_pahse&#39;</span><span class="p">])</span>
    <span class="c1"># RX I Gain correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rgi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_rx_i_dc&#39;</span><span class="p">])</span>
    <span class="c1"># RX Q Gain correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rgq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_rx_q_dc&#39;</span><span class="p">])</span>
    <span class="c1"># RX I DC correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rdi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_rx_i_gain&#39;</span><span class="p">])</span>
    <span class="c1"># RX Q DC correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rdq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_rx_q_gain&#39;</span><span class="p">])</span>
    <span class="c1"># RX phase adjustment</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rpc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_rx_phase&#39;</span><span class="p">])</span>

    <span class="c1"># repetition and acquisition time (acquisition time can only be an integer multiple of the buffer size from Cpp, so the number here will automatically</span>
    <span class="c1"># be adjusted in the ways that it fits to an integer multiply of the buffer size</span>

    <span class="c1"># repetition time = 5e-3</span>
    <span class="n">l</span><span class="o">.</span><span class="n">trp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Readout&#39;</span><span class="p">][</span><span class="s1">&#39;repetition_time&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1"># acquisition time (gives minimum buffer size) =82e-6</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tac</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Readout&#39;</span><span class="p">][</span><span class="s1">&#39;acquisition_time&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span>

    <span class="c1"># GPIO Pin3 is centered around the pulse (used as a Gate Signal)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Readout&#39;</span><span class="p">][</span><span class="s1">&#39;gate_signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="n">l</span><span class="o">.</span><span class="n">t3d</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>   <span class="c1"># [1, 0, 50, 10]</span>

    <span class="c1"># pulse durations</span>
    <span class="c1"># pulse frequency</span>

    <span class="n">l</span><span class="o">.</span><span class="n">pfr</span> <span class="o">=</span> <span class="p">[</span><span class="n">if_frq</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Puls&#39;</span><span class="p">][</span><span class="s1">&#39;number_pulses&#39;</span><span class="p">]))]</span>
    <span class="c1"># pulse  duration</span>

    <span class="c1"># puls = value_sequenz[&#39;Puls&#39;][&#39;puls_duration&#39;]</span>
    <span class="c1"># puls = puls.replace(&quot;[&quot;, &quot;&quot;).replace(&quot;]&quot;, &quot;&quot;)</span>
    <span class="c1"># puls = puls.split(&quot;,&quot;)</span>
    <span class="c1"># puls = [float(i) for i in puls]</span>

    <span class="n">puls</span> <span class="o">=</span> <span class="n">string2array</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Puls&#39;</span><span class="p">][</span><span class="s1">&#39;puls_duration&#39;</span><span class="p">])</span>

    <span class="n">l</span><span class="o">.</span><span class="n">pdr</span> <span class="o">=</span> <span class="n">puls</span>  <span class="c1"># [3e-6]</span>

    <span class="c1"># relative pulse amplitude (only makes sense if 2 or more pulses are in the sequence)</span>
    <span class="n">amplitude</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Puls&#39;</span><span class="p">][</span><span class="s1">&#39;puls_amplitude&#39;</span><span class="p">])</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Puls&#39;</span><span class="p">][</span><span class="s1">&#39;number_pulses&#39;</span><span class="p">]))]</span>
    <span class="n">l</span><span class="o">.</span><span class="n">pam</span> <span class="o">=</span> <span class="n">amplitude</span>  <span class="c1"># [1]</span>

    <span class="c1"># pulse arrangement 1 means immediate start of the pulse (3us from zero approx. is then start of the first pulse)</span>

    <span class="c1"># offset = value_sequenz[&#39;Puls&#39;][&#39;puls_arangement&#39;]</span>
    <span class="c1"># offset = offset.replace(&quot;[&quot;, &quot;&quot;).replace(&quot;]&quot;, &quot;&quot;)</span>
    <span class="c1"># offset = offset.split(&quot;,&quot;)</span>
    <span class="c1"># offset = [float(i) for i in offset]</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">string2array</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Puls&#39;</span><span class="p">][</span><span class="s1">&#39;puls_arangement&#39;</span><span class="p">])</span>

    <span class="c1"># correction for data input</span>
    <span class="n">l</span><span class="o">.</span><span class="n">pof</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">l</span><span class="o">.</span><span class="n">sra</span><span class="p">),</span>
             <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">puls</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">l</span><span class="o">.</span><span class="n">sra</span><span class="p">)]</span>

    <span class="c1"># **************test******************</span>
    <span class="c1"># l.pfr = [if_frq, if_frq]</span>
    <span class="c1"># l.pdr = [3e-6, 6e-6]                   # pulse in mu sec</span>
    <span class="c1"># l.pam = [1, 1]                         # amplitude</span>
    <span class="c1"># l.pof = [300, np.ceil(60e-6*l.sra)]     # offset in sec</span>
    <span class="c1"># ********************************</span>

    <span class="n">l</span><span class="o">.</span><span class="n">npu</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">pfr</span><span class="p">)</span>                                  <span class="c1"># number of pulses</span>

    <span class="n">l</span><span class="o">.</span><span class="n">rgn</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;gain_rx&#39;</span><span class="p">])</span>  <span class="c1"># 55.0    # RX gain</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tgn</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;gain_tx&#39;</span><span class="p">])</span>  <span class="c1"># 40.0  # TX gain</span>

    <span class="n">RX_gainfactor</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">rgn</span> <span class="o">==</span> <span class="mi">40</span><span class="p">:</span>
        <span class="n">RX_gainfactor</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">RX_gainfactor</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">((</span><span class="n">l</span><span class="o">.</span><span class="n">rgn</span><span class="o">-</span><span class="mi">40</span><span class="p">)</span><span class="o">/</span><span class="mi">20</span><span class="p">)</span>

    <span class="c1"># RX BW (IF or base band low pass filter)</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rlp</span> <span class="o">=</span> <span class="mf">3.0e6</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tlp</span> <span class="o">=</span> <span class="mf">130.0e6</span>                                     <span class="c1"># RX BW</span>

    <span class="n">l</span><span class="o">.</span><span class="n">spt</span> <span class="o">=</span> <span class="s1">&#39;./pulse/FID&#39;</span>                              <span class="c1"># directory to save to</span>
    <span class="n">l</span><span class="o">.</span><span class="n">fpa</span> <span class="o">=</span> <span class="s1">&#39;setup&#39;</span>

    <span class="n">l</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="c1"># read back file and plot time signal + shifted fft</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">external_hardware</span><span class="p">):</span>

        <span class="c1"># reads back the file which was recently saved</span>
        <span class="n">l</span><span class="o">.</span><span class="n">readHDF</span><span class="p">()</span>

        <span class="c1"># evaluation range, defines: blanking time and window length</span>
        <span class="n">evran</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;setting&#39;</span><span class="p">][</span><span class="s1">&#39;blank_time&#39;</span><span class="p">]),</span>
                 <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;setting&#39;</span><span class="p">][</span><span class="s1">&#39;window_time&#39;</span><span class="p">])]</span>  <span class="c1"># [22.5, 42.5]</span>

        <span class="c1"># np.where sometimes does not work out, so it is put in a try except</span>
        <span class="c1"># always check the console for errors</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">evidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">l</span><span class="o">.</span><span class="n">HDF</span><span class="o">.</span><span class="n">tdx</span> <span class="o">&gt;</span> <span class="n">evran</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span>
                <span class="n">l</span><span class="o">.</span><span class="n">HDF</span><span class="o">.</span><span class="n">tdx</span> <span class="o">&lt;</span> <span class="n">evran</span><span class="p">[</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;error due to np.where evaluation!&quot;</span><span class="p">)</span>

        <span class="c1"># time domain x and y data</span>
        <span class="n">tdx</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">HDF</span><span class="o">.</span><span class="n">tdx</span><span class="p">[</span><span class="n">evidx</span><span class="p">]</span>
        <span class="n">tdy</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">HDF</span><span class="o">.</span><span class="n">tdy</span><span class="p">[</span><span class="n">evidx</span><span class="p">]</span>

        <span class="c1"># correcting a offset in the time domain by subtracting the mean</span>
        <span class="n">tdy_mean</span> <span class="o">=</span> <span class="n">tdy</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tdy</span><span class="p">)</span>

        <span class="c1"># fft of the corrected time domain data</span>
        <span class="n">fdy1</span> <span class="o">=</span> <span class="n">fftshift</span><span class="p">(</span><span class="n">fft</span><span class="p">(</span><span class="n">tdy_mean</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># fft freq and fft shift is here used to scale the x axis (frequency axis)</span>
        <span class="n">fdx1</span> <span class="o">=</span> <span class="n">fftfreq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fdy1</span><span class="p">))</span><span class="o">*</span><span class="n">l</span><span class="o">.</span><span class="n">sra</span><span class="o">/</span><span class="mf">1e6</span>
        <span class="n">fdx1</span> <span class="o">=</span> <span class="n">fftshift</span><span class="p">(</span><span class="n">fdx1</span><span class="p">)</span>

        <span class="c1"># scaling factor which converts the y axis (usually a proportional number of points) into uV</span>
        <span class="n">fac_p_to_uV</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;factor_point2volts&#39;</span><span class="p">])</span>  <span class="c1"># 447651/1e6</span>

        <span class="n">tdy_mean</span> <span class="o">=</span> <span class="n">tdy_mean</span><span class="o">/</span><span class="n">l</span><span class="o">.</span><span class="n">nav</span><span class="o">/</span><span class="n">fac_p_to_uV</span><span class="o">/</span><span class="n">RX_gainfactor</span>

        <span class="c1"># plt.figure(1);</span>
        <span class="c1"># plt.plot(tdx,tdy_mean)</span>
        <span class="c1"># plt.xlabel(&quot;t in µs&quot;)</span>
        <span class="c1"># plt.ylabel(&quot;Amplitude in µV&quot;)</span>
        <span class="c1"># plt.show()</span>

        <span class="c1"># get LO frequency and add it to the base band fft x-Axis in order to illustrate the applied frequency</span>
        <span class="c1"># for single side spectrum and shift (only single frequency)</span>
        <span class="n">lof</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">HDF</span><span class="o">.</span><span class="n">attr_by_key</span><span class="p">(</span><span class="s1">&#39;lof&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fdx1</span><span class="p">)):</span>
            <span class="n">fdx1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdx1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">lof</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span>

        <span class="n">shifter</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="n">stopper</span> <span class="o">=</span> <span class="mi">270</span>

        <span class="c1"># here the right side of the spectrum is selected</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">fdy1</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fdy1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">shifter</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">fdy1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">stopper</span><span class="p">])</span>
                <span class="p">)</span><span class="o">//</span><span class="n">l</span><span class="o">.</span><span class="n">nav</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">tdx</span><span class="p">)</span><span class="o">/</span><span class="mi">447651</span><span class="o">*</span><span class="mf">1e6</span><span class="o">/</span><span class="n">RX_gainfactor</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">fdx1</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fdy1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">shifter</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">fdy1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">stopper</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;std rms frequency domain next to peak X: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>

        <span class="c1"># plt.figure(2);</span>
        <span class="c1"># plt.plot(x, y)</span>
        <span class="c1"># plt.xlabel(&quot;f in MHz&quot;)</span>
        <span class="c1"># plt.ylabel(&quot;Amplitude in µV&quot;)</span>
        <span class="c1"># plt.title(&quot;double sided spectrum with phase cycling&quot;)</span>
        <span class="c1"># plt.show()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MAX of Signal: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">tdx</span><span class="p">,</span> <span class="n">tdy_mean</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot; hardware is missing&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="seq_comp"><a class="viewcode-back" href="../index.html#run_external.seq_comp">[docs]</a><span class="k">def</span> <span class="nf">seq_comp</span><span class="p">(</span><span class="n">value_main</span><span class="p">,</span> <span class="n">value_sequenz</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;composite pulse sequence with pulses that change their phase in time </span>

<span class="sd">    :param value_main: all parameterst from the main window </span>
<span class="sd">    :type value_main: dict</span>
<span class="sd">    :param value_sequenz: all parameters dependent on the sequence</span>
<span class="sd">    :type value_sequenz: dict</span>
<span class="sd">    :raises Exception: Exception: if not possible to send to the hardware</span>
<span class="sd">    :return: steps time domain, amplitude time domain,steps frequency domain, amplitude frequency domain</span>
<span class="sd">    :rtype: [list, list, list, list]</span>


<span class="sd">    :Example:</span>
<span class="sd">    &gt;&gt;&gt; [x_time, y_time, x_freq, y_freq] = seq_comp (value_main, value_sequenz)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># l = limr.limr(&#39;./pulseN_test_USB.cpp&#39;)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">limr</span><span class="o">.</span><span class="n">limr</span><span class="p">(</span><span class="s1">&#39;./program/pulseN_test_USB.cpp&#39;</span><span class="p">)</span>

    <span class="c1"># hardcoded initialization of the lime. needed if parameters (e.g. Gain, tgi, tdi, are changed and need to be set to chip)</span>
    <span class="n">l</span><span class="o">.</span><span class="n">noi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1"># target frequency of the experiment</span>
    <span class="n">tgtfreq</span> <span class="o">=</span> <span class="mf">83.62e6</span>

    <span class="c1"># IF or base band frequency</span>
    <span class="n">if_frq</span> <span class="o">=</span> <span class="mf">1.2e6</span>

    <span class="c1"># LO frequency (target frequency - base band frequency)</span>
    <span class="n">l</span><span class="o">.</span><span class="n">lof</span> <span class="o">=</span> <span class="n">tgtfreq</span><span class="o">-</span><span class="n">if_frq</span>
    <span class="n">l</span><span class="o">.</span><span class="n">sra</span> <span class="o">=</span> <span class="mf">30.72e6</span>                                     <span class="c1"># Sampling Rate</span>

    <span class="c1"># number of averages</span>
    <span class="n">l</span><span class="o">.</span><span class="n">nav</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s2">&quot;setting&quot;</span><span class="p">][</span><span class="s2">&quot;num_averages&quot;</span><span class="p">])</span>
    <span class="c1"># number of repetitions</span>
    <span class="n">l</span><span class="o">.</span><span class="n">nrp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;setting&#39;</span><span class="p">][</span><span class="s1">&#39;repetition_num&#39;</span><span class="p">])</span>
    <span class="c1"># TX I DC correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tdi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_tx_i_dc&#39;</span><span class="p">])</span>
    <span class="c1"># TX Q DC correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tdq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_tx_q_dc&#39;</span><span class="p">])</span>
    <span class="c1"># TX I Gain correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tgi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_tx_i_gain&#39;</span><span class="p">])</span>
    <span class="c1"># TX Q Gain correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tgq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_tx_q_gain&#39;</span><span class="p">])</span>
    <span class="c1"># TX phase adjustment</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tpc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_tx_pahse&#39;</span><span class="p">])</span>
    <span class="c1"># RX I Gain correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rgi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_rx_i_dc&#39;</span><span class="p">])</span>
    <span class="c1"># RX Q Gain correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rgq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_rx_q_dc&#39;</span><span class="p">])</span>
    <span class="c1"># RX I DC correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rdi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_rx_i_gain&#39;</span><span class="p">])</span>
    <span class="c1"># RX Q DC correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rdq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_rx_q_gain&#39;</span><span class="p">])</span>
    <span class="c1"># RX phase adjustment</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rpc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_rx_phase&#39;</span><span class="p">])</span>

    <span class="c1"># repetition and acquisition time (acquisition time can only be an integer multiple of the buffer size from Cpp, so the number here will automatically</span>
    <span class="c1"># be adjusted in the ways that it fits to an integer multiply of the buffer size</span>

    <span class="c1"># repetition time</span>
    <span class="c1"># l.trp = 5e-3</span>
    <span class="n">l</span><span class="o">.</span><span class="n">trp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Readout&#39;</span><span class="p">][</span><span class="s1">&#39;repetition_time&#39;</span><span class="p">])</span><span class="o">*</span><span class="mi">10</span><span class="o">**-</span><span class="mi">3</span>

    <span class="c1"># acquisition time</span>
    <span class="c1"># l.tac = 82e-6</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tac</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Readout&#39;</span><span class="p">][</span><span class="s1">&#39;acquisition_time&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">6</span>
    <span class="c1"># GPIO Pin3 is centered around the pulse (used as a Gate Signal)</span>
    <span class="c1"># l.t3d=[1, 0, 50, 10]</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Readout&#39;</span><span class="p">][</span><span class="s1">&#39;gate_signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="n">l</span><span class="o">.</span><span class="n">t3d</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>

    <span class="c1"># phase cycling definitions</span>
    <span class="c1"># number of phases (here we only need 4 phases, but the programm cycles now in steps of 45 degree and we always need those 45 degree steps)</span>
    <span class="c1"># l.pcn = [1, 4]</span>
    <span class="n">l</span><span class="o">.</span><span class="n">pcn</span> <span class="o">=</span> <span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Phase&#39;</span><span class="p">][</span><span class="s1">&#39;phase_number&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>

    <span class="c1"># l.pcl = [0,1]                                        # pcyc level (only needed if more then 1 pulse is used (and a relative / different phase is necessary), so only Spin Echo needs/ uses it)</span>
    <span class="c1"># l.pph = [0, np.pi/4]</span>
    <span class="n">l</span><span class="o">.</span><span class="n">pph</span> <span class="o">=</span> <span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Phase&#39;</span><span class="p">][</span><span class="s1">&#39;phase_puls&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>

    <span class="c1"># l.pba = 1</span>

    <span class="c1"># pulse frequency</span>
    <span class="n">l</span><span class="o">.</span><span class="n">pfr</span> <span class="o">=</span> <span class="p">[</span><span class="n">if_frq</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Puls&#39;</span><span class="p">][</span><span class="s1">&#39;number_pulses&#39;</span><span class="p">]))]</span>

    <span class="c1"># pulse  duration</span>
    <span class="n">puls</span> <span class="o">=</span> <span class="n">string2array</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Puls&#39;</span><span class="p">][</span><span class="s1">&#39;puls_duration&#39;</span><span class="p">])</span>
    <span class="n">l</span><span class="o">.</span><span class="n">pdr</span> <span class="o">=</span> <span class="n">puls</span>  <span class="c1"># [3e-6]</span>

    <span class="c1"># relative pulse amplitude (only makes sense if 2 or more pulses are in the sequence)</span>
    <span class="n">amplitude</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Puls&#39;</span><span class="p">][</span><span class="s1">&#39;puls_amplitude&#39;</span><span class="p">])</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Puls&#39;</span><span class="p">][</span><span class="s1">&#39;number_pulses&#39;</span><span class="p">]))]</span>
    <span class="n">l</span><span class="o">.</span><span class="n">pam</span> <span class="o">=</span> <span class="n">amplitude</span>  <span class="c1"># [1]</span>

    <span class="c1"># pulse arrangement 1 means immediate start of the pulse</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">string2array</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Puls&#39;</span><span class="p">][</span><span class="s1">&#39;puls_arangement&#39;</span><span class="p">])</span>
    <span class="c1"># correction for data input only for 2 pulses</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;offset &quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;puls &quot;</span><span class="p">,</span> <span class="n">puls</span><span class="p">)</span>
    <span class="c1"># dont run faster than the allowed :P</span>
    <span class="n">l</span><span class="o">.</span><span class="n">pof</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">l</span><span class="o">.</span><span class="n">sra</span><span class="p">),</span>
             <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">puls</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">l</span><span class="o">.</span><span class="n">sra</span><span class="p">)]</span>

    <span class="c1"># **************test******************</span>
    <span class="c1"># l.pfr = [if_frq, if_frq]</span>
    <span class="c1"># l.pdr = [3e-6, 6e-6]                   # pulse in mu sec</span>
    <span class="c1"># l.pam = [1, 1]                         # amplitude</span>
    <span class="c1"># l.pof = [300, np.ceil(60e-6*l.sra)]     # offset in sec</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> testing&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;puls l.pdr&quot;</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">pdr</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;offset l.pof&quot;</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">pof</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> testing&quot;</span><span class="p">)</span>
    <span class="c1"># ********************************</span>

    <span class="n">l</span><span class="o">.</span><span class="n">npu</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">pfr</span><span class="p">)</span>                              <span class="c1"># number of pulses</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rgn</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;gain_rx&#39;</span><span class="p">])</span>  <span class="c1"># 55.0    # RX gain</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tgn</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;gain_tx&#39;</span><span class="p">])</span>  <span class="c1"># 40.0  # TX gain</span>
    <span class="c1"># l.tgn = 30 # for noise measurements</span>

    <span class="n">RX_gainfactor</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">rgn</span> <span class="o">==</span> <span class="mi">40</span><span class="p">:</span>
        <span class="n">RX_gainfactor</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">RX_gainfactor</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">((</span><span class="n">l</span><span class="o">.</span><span class="n">rgn</span><span class="o">-</span><span class="mi">40</span><span class="p">)</span><span class="o">/</span><span class="mi">20</span><span class="p">)</span>

    <span class="n">l</span><span class="o">.</span><span class="n">rlp</span> <span class="o">=</span> <span class="mf">3.0e6</span>                                          <span class="c1"># RX Base-Band BW</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tlp</span> <span class="o">=</span> <span class="mf">130.0e6</span>                                         <span class="c1"># TX Base-Band BW</span>

    <span class="c1"># pulse arrangement 1 means immediate start of the pulse (3us from zero approx. is then start of the first pulse)</span>

    <span class="c1"># offset = value_sequenz[&#39;Puls&#39;][&#39;puls_arangement&#39;]</span>
    <span class="c1"># offset = offset.replace(&quot;[&quot;, &quot;&quot;).replace(&quot;]&quot;, &quot;&quot;)</span>
    <span class="c1"># offset = offset.split(&quot;,&quot;)</span>
    <span class="c1"># offset = [float(i) for i in offset]</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">string2array</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Puls&#39;</span><span class="p">][</span><span class="s1">&#39;puls_arangement&#39;</span><span class="p">])</span>

    <span class="c1"># correction for data input</span>
    <span class="n">l</span><span class="o">.</span><span class="n">pof</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">l</span><span class="o">.</span><span class="n">sra</span><span class="p">),</span>
             <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">puls</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">l</span><span class="o">.</span><span class="n">sra</span><span class="p">)]</span>

    <span class="c1"># **************test******************</span>
    <span class="c1"># l.pfr = [if_frq, if_frq]</span>
    <span class="c1"># l.pdr = [3e-6, 6e-6]                   # pulse in mu sec</span>
    <span class="c1"># l.pam = [1, 1]                         # amplitude</span>
    <span class="c1"># l.pof = [300, np.ceil(60e-6*l.sra)]     # offset in sec</span>
    <span class="c1"># ********************************</span>

    <span class="n">l</span><span class="o">.</span><span class="n">spt</span> <span class="o">=</span> <span class="s1">&#39;./pulse/FID&#39;</span>                                  <span class="c1"># directory to save to</span>
    <span class="n">l</span><span class="o">.</span><span class="n">fpa</span> <span class="o">=</span> <span class="s1">&#39;setup&#39;</span>

    <span class="n">l</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">external_hardware</span><span class="p">):</span>

        <span class="n">l</span><span class="o">.</span><span class="n">readHDF</span><span class="p">()</span>

        <span class="n">evran</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;setting&#39;</span><span class="p">][</span><span class="s1">&#39;blank_time&#39;</span><span class="p">]),</span>
                 <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;setting&#39;</span><span class="p">][</span><span class="s1">&#39;window_time&#39;</span><span class="p">])]</span>  <span class="c1"># [27.5, 47.5]</span>

        <span class="n">evidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">l</span><span class="o">.</span><span class="n">HDF</span><span class="o">.</span><span class="n">tdx</span> <span class="o">&gt;</span> <span class="n">evran</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">HDF</span><span class="o">.</span><span class="n">tdx</span> <span class="o">&lt;</span> <span class="n">evran</span><span class="p">[</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">evran</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="n">tdx</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">HDF</span><span class="o">.</span><span class="n">tdx</span><span class="p">[</span><span class="n">evidx</span><span class="p">]</span>
        <span class="n">tdy</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">HDF</span><span class="o">.</span><span class="n">tdy</span><span class="p">[</span><span class="n">evidx</span><span class="p">]</span>

        <span class="n">tdy_mean_self</span> <span class="o">=</span> <span class="n">tdy</span>
        <span class="n">tdy_mean</span> <span class="o">=</span> <span class="n">tdy</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tdy</span><span class="p">)</span>

        <span class="n">tdy_mean_0_45</span> <span class="o">=</span> <span class="n">tdy_mean</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">tdy_mean_0_135</span> <span class="o">=</span> <span class="n">tdy_mean</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">tdy_mean_0_m135</span> <span class="o">=</span> <span class="n">tdy_mean</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">tdy_mean_0_m45</span> <span class="o">=</span> <span class="n">tdy_mean</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>

        <span class="n">tdy_comp</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">tdy_mean_0_45</span> <span class="o">+</span> <span class="n">tdy_mean_0_135</span> <span class="o">-</span>
                    <span class="n">tdy_mean_0_m135</span> <span class="o">+</span> <span class="n">tdy_mean_0_m45</span><span class="p">)</span>

        <span class="n">tdy_time</span> <span class="o">=</span> <span class="n">tdy_comp</span><span class="o">/</span><span class="n">l</span><span class="o">.</span><span class="n">nav</span><span class="o">/</span><span class="mi">447651</span><span class="o">*</span><span class="mf">1e6</span>
        <span class="c1"># print(&quot;tdy_time&quot;, tdy_time[:10])</span>
        <span class="c1"># [[ 1.84069325+5.41949576j] [-0.09787128+5.64195399j][-0.23770217+4.23728919j] ...]</span>

        <span class="n">tdy_time</span> <span class="o">=</span> <span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tdy_time</span><span class="p">]</span>

        <span class="n">fdy1</span> <span class="o">=</span> <span class="n">fftshift</span><span class="p">(</span><span class="n">fft</span><span class="p">(</span><span class="n">tdy_mean</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">fdy2</span> <span class="o">=</span> <span class="n">fftshift</span><span class="p">(</span><span class="n">fft</span><span class="p">(</span><span class="n">tdy</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">fdy_comp</span> <span class="o">=</span> <span class="n">fftshift</span><span class="p">(</span><span class="n">fft</span><span class="p">(</span><span class="n">tdy_comp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># print(len(fdy1))</span>

        <span class="n">fdx1</span> <span class="o">=</span> <span class="n">fftfreq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fdy1</span><span class="p">))</span><span class="o">*</span><span class="mf">30.72</span>
        <span class="n">fdx1</span> <span class="o">=</span> <span class="n">fftshift</span><span class="p">(</span><span class="n">fdx1</span><span class="p">)</span>

        <span class="n">fdx_comp</span> <span class="o">=</span> <span class="n">fftfreq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fdy_comp</span><span class="p">))</span><span class="o">*</span><span class="mf">30.72</span>
        <span class="n">fdx_comp</span> <span class="o">=</span> <span class="n">fftshift</span><span class="p">(</span><span class="n">fdx_comp</span><span class="p">)</span>

        <span class="c1"># get rid of dc offset</span>
        <span class="n">nums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fdy1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># plt.figure(1);</span>
        <span class="c1"># plt.plot(tdx,tdy_comp/l.nav/447651*1e6)</span>
        <span class="c1"># plt.xlabel(&quot;t in µs&quot;)</span>
        <span class="c1"># plt.ylabel(&quot;Amplitude in µV&quot;)</span>
        <span class="c1"># plt.show()</span>

        <span class="n">lof</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">HDF</span><span class="o">.</span><span class="n">attr_by_key</span><span class="p">(</span><span class="s1">&#39;lof&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fdx1</span><span class="p">)):</span>
            <span class="n">fdx1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdx1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">lof</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span>
            <span class="c1"># print(fdx1[i])</span>

        <span class="c1"># fft of composite pulsed sequence</span>
        <span class="n">shifter</span> <span class="o">=</span> <span class="mi">12</span>  <span class="c1"># 0#50</span>
        <span class="n">stopper</span> <span class="o">=</span> <span class="mi">270</span>  <span class="c1"># 300</span>

        <span class="n">y</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span>
            <span class="p">(</span><span class="n">fdy_comp</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fdy_comp</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">shifter</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">fdy_comp</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">stopper</span><span class="p">]))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">fdx1</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fdy_comp</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">shifter</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">fdy_comp</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">stopper</span><span class="p">]</span>

        <span class="n">y_freq</span> <span class="o">=</span> <span class="n">y</span><span class="o">/</span><span class="n">l</span><span class="o">.</span><span class="n">nav</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">tdx</span><span class="p">)</span><span class="o">/</span><span class="mi">447651</span><span class="o">*</span><span class="mf">1e6</span><span class="o">/</span><span class="n">RX_gainfactor</span>

        <span class="n">y_freq</span> <span class="o">=</span> <span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">y_freq</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;std rms frequency domain next to peak X: &quot;</span> <span class="o">+</span>
              <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="n">l</span><span class="o">.</span><span class="n">nav</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">tdx</span><span class="p">)</span><span class="o">/</span><span class="mi">447651</span><span class="o">*</span><span class="mf">1e6</span><span class="o">/</span><span class="n">RX_gainfactor</span><span class="p">)))</span>

        <span class="c1"># plt.figure(2);</span>
        <span class="c1"># plt.plot(x, y/l.nav/len(tdx)/447651*1e6/RX_gainfactor)</span>
        <span class="c1"># plt.xlabel(&quot;f in MHz&quot;)</span>
        <span class="c1"># plt.ylabel(&quot;Amplitude in µV&quot;)</span>
        <span class="c1"># plt.title(&quot;composite&quot;)</span>
        <span class="c1"># plt.show()</span>

        <span class="k">return</span> <span class="n">tdx</span><span class="p">,</span> <span class="n">tdy_time</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y_freq</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot; hardware is missing&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="seq_spin_phase"><a class="viewcode-back" href="../index.html#run_external.seq_spin_phase">[docs]</a><span class="k">def</span> <span class="nf">seq_spin_phase</span><span class="p">(</span><span class="n">value_main</span><span class="p">,</span> <span class="n">value_sequenz</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;spin-echo with phase-cycling  sequence</span>

<span class="sd">    :param value_main: all parameterst from the main window </span>
<span class="sd">    :type value_main: dict</span>
<span class="sd">    :param value_sequenz: all parameters dependent on the sequence</span>
<span class="sd">    :type value_sequenz: dict</span>
<span class="sd">    :raises Exception: Exception: if not possible to send to the hardware</span>
<span class="sd">    :return: steps time domain, amplitude time domain,steps frequency domain, amplitude frequency domain</span>
<span class="sd">    :rtype: [list, list, list, list]</span>


<span class="sd">    :Example:</span>
<span class="sd">    &gt;&gt;&gt; [x_time, y_time, x_freq, y_freq] = seq_spin_phase(value_main, value_sequenz)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># l = limr.limr(&#39;./pulseN_test_USB.cpp&#39;)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">limr</span><span class="o">.</span><span class="n">limr</span><span class="p">(</span><span class="s1">&#39;./program/pulseN_test_USB.cpp&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">phase_shift</span><span class="p">(</span><span class="n">iptsignal</span><span class="p">,</span> <span class="n">angle</span><span class="p">):</span>
        <span class="c1"># Resolve the signal&#39;s fourier spectrum</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">fft</span><span class="p">(</span><span class="n">iptsignal</span><span class="p">)</span>
        <span class="c1"># freq = rfftfreq(iptsignal.size, d=dt)</span>

        <span class="c1"># Perform phase shift in freqeuency domain</span>
        <span class="c1"># default it was +1.0j</span>
        <span class="n">spec</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="n">j</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span>

        <span class="c1"># Inverse FFT back to time domain</span>
        <span class="n">phaseshift</span> <span class="o">=</span> <span class="n">ifft</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">iptsignal</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">phaseshift</span>

    <span class="c1"># hardcoded initialization of the lime. needed if parameters (e.g. Gain, tgi, tdi, are changed and need to be set to chip)</span>
    <span class="n">l</span><span class="o">.</span><span class="n">noi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1"># target frequency of the experiment</span>
    <span class="n">tgtfreq</span> <span class="o">=</span> <span class="mf">83.62e6</span>

    <span class="c1"># IF or base band frequency</span>
    <span class="n">if_frq</span> <span class="o">=</span> <span class="mf">1.2e6</span>

    <span class="c1"># LO frequency (target7 frequency - base band frequency)</span>
    <span class="n">l</span><span class="o">.</span><span class="n">lof</span> <span class="o">=</span> <span class="n">tgtfreq</span><span class="o">-</span><span class="n">if_frq</span>
    <span class="n">l</span><span class="o">.</span><span class="n">sra</span> <span class="o">=</span> <span class="mf">30.72e6</span>                                     <span class="c1"># Sampling Rate</span>

    <span class="c1"># number of averages</span>
    <span class="n">l</span><span class="o">.</span><span class="n">nav</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s2">&quot;setting&quot;</span><span class="p">][</span><span class="s2">&quot;num_averages&quot;</span><span class="p">])</span>
    <span class="c1"># number of repetitions</span>

    <span class="n">l</span><span class="o">.</span><span class="n">nrp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;setting&#39;</span><span class="p">][</span><span class="s1">&#39;repetition_num&#39;</span><span class="p">])</span>
    <span class="c1"># TX I DC correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tdi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_tx_i_dc&#39;</span><span class="p">])</span>
    <span class="c1"># TX Q DC correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tdq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_tx_q_dc&#39;</span><span class="p">])</span>
    <span class="c1"># TX I Gain correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tgi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_tx_i_gain&#39;</span><span class="p">])</span>
    <span class="c1"># TX Q Gain correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tgq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_tx_q_gain&#39;</span><span class="p">])</span>
    <span class="c1"># TX phase adjustment</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tpc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_tx_pahse&#39;</span><span class="p">])</span>
    <span class="c1"># RX I Gain correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rgi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_rx_i_dc&#39;</span><span class="p">])</span>
    <span class="c1"># RX Q Gain correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rgq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_rx_q_dc&#39;</span><span class="p">])</span>
    <span class="c1"># RX I DC correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rdi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_rx_i_gain&#39;</span><span class="p">])</span>
    <span class="c1"># RX Q DC correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rdq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_rx_q_gain&#39;</span><span class="p">])</span>
    <span class="c1"># RX phase adjustment</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rpc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_rx_phase&#39;</span><span class="p">])</span>

    <span class="c1"># repetition and acquisition time (acquisition time can only be an integer multiple of the buffer size from Cpp, so the number here will automatically</span>
    <span class="c1"># be adjusted in the ways that it fits to an integer multiply of the buffer size</span>

    <span class="c1"># repetition time = 5e-3</span>
    <span class="n">l</span><span class="o">.</span><span class="n">trp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Readout&#39;</span><span class="p">][</span><span class="s1">&#39;repetition_time&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1"># acquisition time (gives minimum buffer size) =82e-6</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tac</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Readout&#39;</span><span class="p">][</span><span class="s1">&#39;acquisition_time&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span>

    <span class="c1"># GPIO Pin3 is centered around the pulse (used as a Gate Signal)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Readout&#39;</span><span class="p">][</span><span class="s1">&#39;gate_signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="n">l</span><span class="o">.</span><span class="n">t3d</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>   <span class="c1"># [1, 0, 50, 10]</span>

    <span class="c1"># pulse durations</span>
    <span class="c1"># pulse frequency</span>
    <span class="c1"># l.pfr = [if_frq]</span>
    <span class="n">l</span><span class="o">.</span><span class="n">pfr</span> <span class="o">=</span> <span class="p">[</span><span class="n">if_frq</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Puls&#39;</span><span class="p">][</span><span class="s1">&#39;number_pulses&#39;</span><span class="p">]))]</span>
    <span class="n">puls</span> <span class="o">=</span> <span class="n">string2array</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Puls&#39;</span><span class="p">][</span><span class="s1">&#39;puls_duration&#39;</span><span class="p">])</span>
    <span class="c1"># pulse  duration</span>
    <span class="n">l</span><span class="o">.</span><span class="n">pdr</span> <span class="o">=</span> <span class="n">puls</span>  <span class="c1"># [3e-6]</span>
    <span class="c1"># relative pulse amplitude (only makes sense if 2 or more pulses are in the sequence)</span>

    <span class="c1"># relative pulse amplitude (only makes sense if 2 or more pulses are in the sequence)</span>
    <span class="n">amplitude</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Puls&#39;</span><span class="p">][</span><span class="s1">&#39;puls_amplitude&#39;</span><span class="p">])</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Puls&#39;</span><span class="p">][</span><span class="s1">&#39;number_pulses&#39;</span><span class="p">]))]</span>
    <span class="n">l</span><span class="o">.</span><span class="n">pam</span> <span class="o">=</span> <span class="n">amplitude</span>  <span class="c1"># [1]</span>

    <span class="c1"># pulse arrangement 1 means immediate start of the pulse (3us from zero approx. is then start of the first pulse)</span>

    <span class="c1"># offset = value_sequenz[&#39;Puls&#39;][&#39;puls_arangement&#39;]</span>
    <span class="c1"># offset = offset.replace(&quot;[&quot;, &quot;&quot;).replace(&quot;]&quot;, &quot;&quot;)</span>
    <span class="c1"># offset = offset.split(&quot;,&quot;)</span>
    <span class="c1"># offset = [float(i) for i in offset]</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">string2array</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Puls&#39;</span><span class="p">][</span><span class="s1">&#39;puls_arangement&#39;</span><span class="p">])</span>

    <span class="c1"># correction for data input</span>
    <span class="n">l</span><span class="o">.</span><span class="n">pof</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">l</span><span class="o">.</span><span class="n">sra</span><span class="p">),</span>
             <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">puls</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">l</span><span class="o">.</span><span class="n">sra</span><span class="p">)]</span>

    <span class="n">l</span><span class="o">.</span><span class="n">npu</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">pfr</span><span class="p">)</span>                                  <span class="c1"># number of pulses</span>

    <span class="c1"># phase cycling definitions</span>
    <span class="c1"># number of phases (here we only need 4 phases, but the programm cycles now in steps of 45 degree and we always need those 45 degree steps)</span>
    <span class="c1"># l.pcn = [1, 4]</span>
    <span class="c1">#l.pcn = value_sequenz[&#39;Phase&#39;][&#39;phase_number&#39;].split(&quot; &quot;)</span>

    <span class="c1"># l.pcl = [0,1]                                        # pcyc level (only needed if more then 1 pulse is used (and a relative / different phase is necessary), so only Spin Echo needs/ uses it)</span>
    <span class="c1"># l.pph = [0, np.pi/4]</span>
    <span class="c1">#l.pph = value_sequenz[&#39;Phase&#39;][&#39;phase_puls&#39;].split(&quot; &quot;)</span>

    <span class="c1"># test</span>
    <span class="n">l</span><span class="o">.</span><span class="n">pcn</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>                                      <span class="c1"># number of phases</span>
    <span class="n">l</span><span class="o">.</span><span class="n">pph</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># pulse phase (added to phase shift due to pcn)</span>
    <span class="c1"># test</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----------------------------------------------------------------------------------------------------------------------------------------------&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> puls l.pof &quot;</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">pof</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;offset l.pdr  &quot;</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">pdr</span><span class="p">)</span>

    <span class="c1"># RX gain between 5 and 55 (usually 40 was used, 55 better and maximum)</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rgn</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;gain_rx&#39;</span><span class="p">])</span>  <span class="c1"># 55.0    # RX gain</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tgn</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;gain_tx&#39;</span><span class="p">])</span>  <span class="c1"># 40.0  # TX gain</span>

    <span class="c1"># RX gain was set to 40 dB when the scaling facotr from points to V was determined - so a higher or lower values then 40 need correction for the plots</span>
    <span class="n">RX_gainfactor</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">rgn</span> <span class="o">==</span> <span class="mi">40</span><span class="p">:</span>
        <span class="n">RX_gainfactor</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">RX_gainfactor</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">((</span><span class="n">l</span><span class="o">.</span><span class="n">rgn</span><span class="o">-</span><span class="mi">40</span><span class="p">)</span><span class="o">/</span><span class="mi">20</span><span class="p">)</span>

    <span class="n">l</span><span class="o">.</span><span class="n">rlp</span> <span class="o">=</span> <span class="mf">3.0e6</span>                                        <span class="c1"># RX BW</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tlp</span> <span class="o">=</span> <span class="mf">130.0e6</span>                                      <span class="c1"># RX BW</span>

    <span class="n">l</span><span class="o">.</span><span class="n">spt</span> <span class="o">=</span> <span class="s1">&#39;./pulse/SCAN&#39;</span>                              <span class="c1"># directory to save to</span>
    <span class="n">l</span><span class="o">.</span><span class="n">fpa</span> <span class="o">=</span> <span class="s1">&#39;setup&#39;</span>

    <span class="c1"># call to program</span>
    <span class="n">l</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="c1"># read back and post-processing</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">external_hardware</span><span class="p">):</span>

        <span class="n">l</span><span class="o">.</span><span class="n">readHDF</span><span class="p">()</span>

        <span class="c1"># select range which should be investigated (ECHO time setting)</span>
        <span class="n">evran</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;setting&#39;</span><span class="p">][</span><span class="s1">&#39;blank_time&#39;</span><span class="p">]),</span>
                 <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;setting&#39;</span><span class="p">][</span><span class="s1">&#39;window_time&#39;</span><span class="p">])]</span>

        <span class="n">evidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">l</span><span class="o">.</span><span class="n">HDF</span><span class="o">.</span><span class="n">tdx</span> <span class="o">&gt;</span> <span class="n">evran</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">HDF</span><span class="o">.</span><span class="n">tdx</span> <span class="o">&lt;</span> <span class="n">evran</span><span class="p">[</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">tdx</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">HDF</span><span class="o">.</span><span class="n">tdx</span><span class="p">[</span><span class="n">evidx</span><span class="p">]</span>
        <span class="n">tdy</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">HDF</span><span class="o">.</span><span class="n">tdy</span><span class="p">[</span><span class="n">evidx</span><span class="p">]</span>

        <span class="n">tdy_mean</span> <span class="o">=</span> <span class="n">tdy</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tdy</span><span class="p">)</span>

        <span class="c1"># take RX time domain data from hdf5 file</span>
        <span class="n">tdy_mean_0_90</span> <span class="o">=</span> <span class="n">tdy_mean</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">tdy_mean_90_90</span> <span class="o">=</span> <span class="n">tdy_mean</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">tdy_mean_180_90</span> <span class="o">=</span> <span class="n">tdy_mean</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">tdy_mean_270_90</span> <span class="o">=</span> <span class="n">tdy_mean</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>

        <span class="c1"># use function to shift RX phaseaccordingly to kazan (therefore k1, k2, k3, k4)</span>
        <span class="n">k1</span> <span class="o">=</span> <span class="n">tdy_mean_0_90</span>
        <span class="n">k2</span> <span class="o">=</span> <span class="n">phase_shift</span><span class="p">(</span><span class="n">tdy_mean_90_90</span><span class="p">,</span> <span class="mi">270</span><span class="p">)</span>
        <span class="n">k3</span> <span class="o">=</span> <span class="n">phase_shift</span><span class="p">(</span><span class="n">tdy_mean_180_90</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>
        <span class="n">k4</span> <span class="o">=</span> <span class="n">phase_shift</span><span class="p">(</span><span class="n">tdy_mean_270_90</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">k1</span><span class="p">),</span> <span class="s2">&quot;k1&quot;</span><span class="p">,</span> <span class="n">k1</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;k2&quot;</span><span class="p">,</span> <span class="n">k2</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;k3&quot;</span><span class="p">,</span> <span class="n">k3</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;k4&quot;</span><span class="p">,</span> <span class="n">k4</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>

        <span class="n">tdy_mean_self</span> <span class="o">=</span> <span class="p">(</span><span class="n">k1</span><span class="o">+</span><span class="n">k2</span><span class="o">+</span><span class="n">k3</span><span class="o">+</span><span class="n">k4</span><span class="p">)</span>
        <span class="n">tdy_time</span> <span class="o">=</span> <span class="n">tdy_mean_self</span><span class="o">/</span><span class="n">l</span><span class="o">.</span><span class="n">nav</span><span class="o">/</span><span class="mi">447651</span><span class="o">*</span><span class="mf">1e6</span><span class="o">/</span><span class="n">RX_gainfactor</span><span class="o">/</span><span class="mi">4</span>
        <span class="n">tdy_time</span> <span class="o">=</span> <span class="n">tdy_mean_self</span>

        <span class="c1"># #plot resulting time domain data and scale it to uV</span>
        <span class="c1"># plt.figure(1);</span>
        <span class="c1"># plt.plot(tdx, tdy_time)</span>
        <span class="c1"># plt.xlabel(&quot;t in µs&quot;)</span>
        <span class="c1"># plt.ylabel(&quot;Amplitude in µV&quot;)</span>
        <span class="c1"># plt.show()</span>

        <span class="n">fdy1</span> <span class="o">=</span> <span class="n">fftshift</span><span class="p">(</span><span class="n">fft</span><span class="p">(</span><span class="n">tdy_mean_self</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">fdx1</span> <span class="o">=</span> <span class="n">fftfreq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fdy1</span><span class="p">))</span><span class="o">*</span><span class="n">l</span><span class="o">.</span><span class="n">sra</span><span class="o">/</span><span class="mf">1e6</span>
        <span class="c1">#fdx1 = fftshift(fdx1)</span>

        <span class="c1"># for single side spectrum and shift (only single frequency)</span>
        <span class="n">lof</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">HDF</span><span class="o">.</span><span class="n">attr_by_key</span><span class="p">(</span><span class="s1">&#39;lof&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fdx1</span><span class="p">)):</span>
            <span class="n">fdx1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdx1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">lof</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span>

        <span class="n">shifter</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="n">stopper</span> <span class="o">=</span> <span class="mi">270</span>

        <span class="c1"># here the right side of the spectrum is selected</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">fdy1</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fdy1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">shifter</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">fdy1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">stopper</span><span class="p">])</span>
                <span class="p">)</span><span class="o">//</span><span class="n">l</span><span class="o">.</span><span class="n">nav</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">tdx</span><span class="p">)</span><span class="o">/</span><span class="mi">447651</span><span class="o">*</span><span class="mf">1e6</span><span class="o">/</span><span class="mi">4</span><span class="o">/</span><span class="n">RX_gainfactor</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">fdx1</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fdy1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">shifter</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">fdy1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">stopper</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;std rms frequency domain next to peak X: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MAX of Signal: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>

        <span class="c1"># plt.figure(2)</span>
        <span class="c1"># plt.plot(x, y)</span>
        <span class="c1"># plt.xlabel(&quot;f in MHz&quot;)</span>
        <span class="c1"># plt.ylabel(&quot;Amplitude in µV&quot;)</span>
        <span class="c1"># plt.title(&quot;double sided spectrum with phase cycling&quot;)</span>
        <span class="c1"># plt.show()</span>
        <span class="n">tdy_time</span> <span class="o">=</span> <span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tdy_time</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">tdx</span><span class="p">,</span> <span class="n">tdy_time</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot; hardware is missing&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="seq_own"><a class="viewcode-back" href="../index.html#run_external.seq_own">[docs]</a><span class="k">def</span> <span class="nf">seq_own</span><span class="p">(</span><span class="n">value_main</span><span class="p">,</span> <span class="n">value_sequenz</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;own sequence can be used to desine a arbitrary sequence used with up to 10 pulses und all its dependet phases</span>

<span class="sd">    :param value_main: all parameterst from the main window </span>
<span class="sd">    :type value_main: dict</span>
<span class="sd">    :param value_sequenz: all parameters dependent on the sequence</span>
<span class="sd">    :type value_sequenz: dict</span>
<span class="sd">    :raises Exception: Exception: if not possible to send to the hardware</span>
<span class="sd">    :return: steps time domain, amplitude time domain,steps frequency domain, amplitude frequency domain</span>
<span class="sd">    :rtype: [list, list, list, list]</span>


<span class="sd">    :Example:</span>
<span class="sd">    &gt;&gt;&gt; [x_time, y_time, x_freq, y_freq] = seq_own(value_main, value_sequenz)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">l</span> <span class="o">=</span> <span class="n">limr</span><span class="o">.</span><span class="n">limr</span><span class="p">(</span><span class="s1">&#39;./program/pulseN_test_USB.cpp&#39;</span><span class="p">)</span>
    <span class="n">l</span><span class="o">.</span><span class="n">noi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1"># target frequency of the experiment</span>
    <span class="n">tgtfreq</span> <span class="o">=</span> <span class="mf">83.62e6</span>

    <span class="c1"># IF or base band frequency</span>
    <span class="n">if_frq</span> <span class="o">=</span> <span class="mf">1.2e6</span>

    <span class="c1"># LO frequency (target7 frequency - base band frequency)</span>
    <span class="n">l</span><span class="o">.</span><span class="n">lof</span> <span class="o">=</span> <span class="n">tgtfreq</span><span class="o">-</span><span class="n">if_frq</span>
    <span class="c1"># Sampling Rate</span>
    <span class="n">l</span><span class="o">.</span><span class="n">sra</span> <span class="o">=</span> <span class="mf">30.72e6</span>
    <span class="c1"># number of averages</span>
    <span class="n">l</span><span class="o">.</span><span class="n">nav</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s2">&quot;setting&quot;</span><span class="p">][</span><span class="s2">&quot;num_averages&quot;</span><span class="p">])</span>
    <span class="c1"># number of repetitions</span>

    <span class="n">l</span><span class="o">.</span><span class="n">nrp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;setting&#39;</span><span class="p">][</span><span class="s1">&#39;repetition_num&#39;</span><span class="p">])</span>
    <span class="c1"># TX I DC correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tdi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_tx_i_dc&#39;</span><span class="p">])</span>
    <span class="c1"># TX Q DC correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tdq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_tx_q_dc&#39;</span><span class="p">])</span>
    <span class="c1"># TX I Gain correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tgi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_tx_i_gain&#39;</span><span class="p">])</span>
    <span class="c1"># TX Q Gain correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tgq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_tx_q_gain&#39;</span><span class="p">])</span>
    <span class="c1"># TX phase adjustment</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tpc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_tx_pahse&#39;</span><span class="p">])</span>
    <span class="c1"># RX I Gain correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rgi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_rx_i_dc&#39;</span><span class="p">])</span>
    <span class="c1"># RX Q Gain correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rgq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_rx_q_dc&#39;</span><span class="p">])</span>
    <span class="c1"># RX I DC correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rdi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_rx_i_gain&#39;</span><span class="p">])</span>
    <span class="c1"># RX Q DC correction</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rdq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_rx_q_gain&#39;</span><span class="p">])</span>
    <span class="c1"># RX phase adjustment</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rpc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;correction_rx_phase&#39;</span><span class="p">])</span>

    <span class="c1"># repetition and acquisition time (acquisition time can only be an integer multiple of the buffer size from Cpp, so the number here will automatically</span>
    <span class="c1"># be adjusted in the ways that it fits to an integer multiply of the buffer size</span>

    <span class="c1"># repetition time = 5e-3</span>
    <span class="n">l</span><span class="o">.</span><span class="n">trp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Readout&#39;</span><span class="p">][</span><span class="s1">&#39;repetition_time&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1"># acquisition time (gives minimum buffer size) =82e-6</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tac</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Readout&#39;</span><span class="p">][</span><span class="s1">&#39;acquisition_time&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span>

    <span class="c1"># GPIO Pin3 is centered around the pulse (used as a Gate Signal)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Readout&#39;</span><span class="p">][</span><span class="s1">&#39;gate_signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="n">l</span><span class="o">.</span><span class="n">t3d</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>   <span class="c1"># [1, 0, 50, 10]</span>

    <span class="c1"># pulse durations</span>
    <span class="c1"># pulse frequency</span>

    <span class="n">l</span><span class="o">.</span><span class="n">pfr</span> <span class="o">=</span> <span class="p">[</span><span class="n">if_frq</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Puls&#39;</span><span class="p">][</span><span class="s1">&#39;number_pulses&#39;</span><span class="p">]))]</span>
    <span class="c1"># pulse  duration</span>

    <span class="c1"># puls = value_sequenz[&#39;Puls&#39;][&#39;puls_duration&#39;]</span>
    <span class="c1"># puls = puls.replace(&quot;[&quot;, &quot;&quot;).replace(&quot;]&quot;, &quot;&quot;)</span>
    <span class="c1"># puls = puls.split(&quot;,&quot;)</span>
    <span class="c1"># puls = [float(i) for i in puls]</span>

    <span class="n">puls</span> <span class="o">=</span> <span class="n">string2array</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Puls&#39;</span><span class="p">][</span><span class="s1">&#39;puls_duration&#39;</span><span class="p">])</span>
    <span class="n">l</span><span class="o">.</span><span class="n">pdr</span> <span class="o">=</span> <span class="n">puls</span>  <span class="c1"># [3e-6]</span>

    <span class="c1"># relative pulse amplitude (only makes sense if 2 or more pulses are in the sequence)</span>
    <span class="n">amplitude</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Puls&#39;</span><span class="p">][</span><span class="s1">&#39;puls_amplitude&#39;</span><span class="p">])</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Puls&#39;</span><span class="p">][</span><span class="s1">&#39;number_pulses&#39;</span><span class="p">]))]</span>
    <span class="n">l</span><span class="o">.</span><span class="n">pam</span> <span class="o">=</span> <span class="n">amplitude</span>  <span class="c1"># [1]</span>

    <span class="c1"># pulse arrangement 1 means immediate start of the pulse (3us from zero approx. is then start of the first pulse)</span>

    <span class="c1"># offset = value_sequenz[&#39;Puls&#39;][&#39;puls_arangement&#39;]</span>
    <span class="c1"># offset = offset.replace(&quot;[&quot;, &quot;&quot;).replace(&quot;]&quot;, &quot;&quot;)</span>
    <span class="c1"># offset = offset.split(&quot;,&quot;)</span>
    <span class="c1"># offset = [float(i) for i in offset]</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">string2array</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;Puls&#39;</span><span class="p">][</span><span class="s1">&#39;puls_arangement&#39;</span><span class="p">])</span>

    <span class="c1"># correction for data input</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;offset&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;puls&quot;</span><span class="p">,</span> <span class="n">puls</span><span class="p">)</span>
    <span class="c1">#l.pof = [offset[0], np.ceil((offset[1] + puls[0]) * l.sra)]</span>

    <span class="n">puls</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span> <span class="o">+</span> <span class="n">puls</span>  <span class="c1"># shift pulses to align with offset</span>
    <span class="n">offset_shift</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">offset</span><span class="p">):</span>
        <span class="c1">#print(i, &quot;offset:&quot;, type(offset[i]), &quot; pulse:&quot;, type(puls[i]))</span>
        <span class="c1">#print(i, &quot;offset:&quot;, (offset[i]), &quot; pulse:&quot;, (puls[i]))</span>
        <span class="n">offset_sum</span> <span class="o">=</span> <span class="n">puls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">offset_sum</span> <span class="o">=</span> <span class="n">offset_sum</span> <span class="o">*</span> <span class="n">l</span><span class="o">.</span><span class="n">sra</span>
        <span class="n">offset_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">offset_sum</span><span class="p">)</span>
        <span class="c1">#print(&quot;offset_sum&quot;, offset_sum)</span>
        <span class="n">offset_shift</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">offset_sum</span><span class="p">)</span>
    <span class="c1"># first offest parameter defalt set, hardware requirement</span>
    <span class="n">offset_shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">300</span>

    <span class="c1"># offset = [np.ceil(float(offset[i] + puls[i]) * l.sra)</span>
    <span class="c1">#          for i, val in enumerate(offset)]</span>

    <span class="n">l</span><span class="o">.</span><span class="n">pof</span> <span class="o">=</span> <span class="n">offset_shift</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;l.pof &quot;</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">pof</span><span class="p">)</span>
    <span class="c1"># **************test******************</span>
    <span class="c1">#l.pfr = [if_frq, if_frq]</span>
    <span class="c1"># l.pdr = [3e-6, 6e-6]                   # pulse in mu sec</span>
    <span class="c1"># l.pam = [1, 1]                         # amplitude</span>
    <span class="c1"># l.pof = [300, np.ceil(30e-6*l.sra)]    # offset in sec</span>
    <span class="c1"># ********************************</span>

    <span class="n">l</span><span class="o">.</span><span class="n">npu</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">pfr</span><span class="p">)</span>                         <span class="c1"># number of pulses</span>

    <span class="n">l</span><span class="o">.</span><span class="n">rgn</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;gain_rx&#39;</span><span class="p">])</span>  <span class="c1"># 55.0    # RX gain</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tgn</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_sequenz</span><span class="p">[</span><span class="s1">&#39;SDR setting&#39;</span><span class="p">][</span><span class="s1">&#39;gain_tx&#39;</span><span class="p">])</span>  <span class="c1"># 40.0  # TX gain</span>

    <span class="n">RX_gainfactor</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">rgn</span> <span class="o">==</span> <span class="mi">40</span><span class="p">:</span>
        <span class="n">RX_gainfactor</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">RX_gainfactor</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">((</span><span class="n">l</span><span class="o">.</span><span class="n">rgn</span><span class="o">-</span><span class="mi">40</span><span class="p">)</span><span class="o">/</span><span class="mi">20</span><span class="p">)</span>

    <span class="c1"># RX BW (IF or base band low pass filter)</span>
    <span class="n">l</span><span class="o">.</span><span class="n">rlp</span> <span class="o">=</span> <span class="mf">3.0e6</span>
    <span class="n">l</span><span class="o">.</span><span class="n">tlp</span> <span class="o">=</span> <span class="mf">130.0e6</span>                                     <span class="c1"># RX BW</span>

    <span class="n">l</span><span class="o">.</span><span class="n">spt</span> <span class="o">=</span> <span class="n">save_dh5_file</span>                            <span class="c1"># directory to save to</span>
    <span class="n">l</span><span class="o">.</span><span class="n">fpa</span> <span class="o">=</span> <span class="s1">&#39;setup&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> ________</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;start sequenz&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> ________</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">l</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="c1"># retun values</span>
    <span class="n">x_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">22.0</span><span class="p">,</span> <span class="mf">22.1</span><span class="p">,</span> <span class="mf">22.2</span><span class="p">,</span> <span class="mf">22.3</span><span class="p">,</span> <span class="mf">22.4</span><span class="p">,</span>
                      <span class="mf">22.5</span><span class="p">,</span> <span class="mf">22.6</span><span class="p">,</span> <span class="mf">22.7</span><span class="p">,</span> <span class="mf">22.8</span><span class="p">,</span> <span class="mf">22.9</span><span class="p">])</span>
    <span class="n">y_time</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.2</span><span class="o">+</span><span class="mf">9.70</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span><span class="o">+</span><span class="mf">3.0</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span> <span class="o">+</span> <span class="mf">5.31</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="o">+</span><span class="mf">3.0</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span> <span class="o">-</span>
              <span class="mf">0.4</span><span class="n">j</span><span class="p">,</span> <span class="mf">0.4</span><span class="o">-</span><span class="mf">2.3</span><span class="n">j</span><span class="p">,</span> <span class="mf">1.3</span><span class="o">-</span><span class="mf">3.3</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">-</span><span class="mf">4.1</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.7</span><span class="o">-</span><span class="mf">6.4</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.9</span><span class="o">-</span><span class="mf">7.0</span><span class="n">j</span><span class="p">]</span>
    <span class="n">y_time</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.3</span><span class="o">+</span><span class="n">i</span> <span class="o">+</span> <span class="mf">1.50</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
    <span class="n">y_time</span> <span class="o">=</span> <span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">y_time</span><span class="p">]</span>
    <span class="c1"># y_time &lt;class &#39;numpy.complex128&#39;&gt; [0.19533675+9.700897j]</span>

    <span class="n">x_freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">83.0</span><span class="p">,</span> <span class="mf">83.1</span><span class="p">,</span> <span class="mf">83.2</span><span class="p">,</span> <span class="mf">83.3</span><span class="p">,</span> <span class="mf">83.4</span><span class="p">,</span> <span class="mf">83.5</span><span class="p">,</span> <span class="mf">83.6</span><span class="p">,</span> <span class="mf">83.7</span><span class="p">,</span> <span class="mf">83.8</span><span class="p">])</span>
    <span class="n">y_freq</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.9</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]</span>
    <span class="n">y_freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">y_freq</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">x_time</span><span class="p">,</span> <span class="n">y_time</span><span class="p">,</span> <span class="n">x_freq</span><span class="p">,</span> <span class="n">y_freq</span></div>


<div class="viewcode-block" id="send_tune_match"><a class="viewcode-back" href="../index.html#run_external.send_tune_match">[docs]</a><span class="k">def</span> <span class="nf">send_tune_match</span><span class="p">(</span><span class="n">tune</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span> <span class="n">tm_step</span><span class="p">,</span> <span class="n">tm_lut</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;provisions for development of a new tuning and matching system</span>

<span class="sd">    :param tune: max voltage range of tunig capacitor</span>
<span class="sd">    :type tune: float</span>
<span class="sd">    :param match: max voltage range of matching capacitor</span>
<span class="sd">    :type match: float</span>
<span class="sd">    :param tm_step: step size of measured data</span>
<span class="sd">    :type tm_step: int</span>
<span class="sd">    :param tm_lut: resolution of saved measured data</span>
<span class="sd">    :type tm_lut: int</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;start tune and match sequenz on Arduino &quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tune &quot;</span><span class="p">,</span> <span class="n">tune</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;match &quot;</span><span class="p">,</span> <span class="n">match</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tm_step &quot;</span><span class="p">,</span> <span class="n">tm_step</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tm_lut &quot;</span><span class="p">,</span> <span class="n">tm_lut</span><span class="p">)</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Sphinx documentation</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Welcome to the “LimeNQR” documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#module-start">start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#graphical-user-interface">Graphical User Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#module-win_main2">Main Window</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#module-win_load_file">File handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#module-win_sequenz">Sequence handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#variables-handling">Variables handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#run-external-hardware">Run external hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#module-win_plot">Data ploting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#module-function">Helper funktions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#indices-and-tables">Indices and tables</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, MALIN Philipp.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.5.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>